name = "MySQL-Flyway"
description = "Process template to perform Flyway deployments to MySQL."

parameter "ProcessTemplate.Environment" {
    display_settings = {
        Octopus.ControlType = "Environments"
    }
    help_text = "The environment(s) that require the manual intervention step."
    label = "Approval Environment"
}

parameter "ProcessTemplate.WorkerPool" {
    display_settings = {
        Octopus.ControlType = "WorkerPool"
    }
    help_text = "Worker pool that has access to perform database deployments."
    label = "Worker Pool"
}

parameter "ProcessTemplate.Approval.Team" {
    display_settings = {
        Octopus.ControlType = "Teams"
    }
    help_text = "The team responsible for performing approvals."
    label = "Approval Team"
}

parameter "ProcessTemplate.Flyway.Package" {
    display_settings = {
        Octopus.ControlType = "Package"
    }
    help_text = "This package contains the files used by Flyway to perform database migrations."
    label = "Flyway Package"
}

parameter "ProcessTemplate.Jdbc.Connection.String" {
    display_settings = {
        Octopus.ControlType = "SingleLineText"
    }
    help_text = "The JDBC connection string for the database."
    label = "JDBC Connection String"

    value "jdbc:mysql://#{ProcessTemplate.Database.Server.Name}:#{ProcessTemplate.Database.Server.Port}/#{ProcessTemplate.Database.Name}?useUnicode=true" {}
}

parameter "ProcessTemplate.Database.Authentication.User.Name" {
    display_settings = {
        Octopus.ControlType = "SingleLineText"
    }
    help_text = "(Optional) The database username to use for the connection, leave blank if using other authentication methods."
    is_optional = true
    label = "Database Username"
}

parameter "ProcessTemplate.Database.Authentication.User.Password" {
    display_settings = {
        Octopus.ControlType = "Sensitive"
    }
    help_text = "(Optional) The password for the database username to use for the connection, leave blank if using other authentication methods."
    is_optional = true
    label = "Database User Password"
}

parameter "ProcessTemplate.Database.Authentication.Method" {
    display_settings = {
        Octopus.ControlType = "Select"
        Octopus.SelectOptions = <<-EOT
            awsiam|AWS EC2 IAM Role
            azuremanagedidentity|Azure Managed Identity
            gcpserviceaccount|GCP Service Account
            usernamepassword|Username\Password
            windowsauthentication|Windows Authentication
            EOT
    }
    help_text = "Choose the authentication method used to connect to the database."
    label = "Authentication Method"
}

parameter "ProcessTemplate.Database.Server.Name" {
    display_settings = {
        Octopus.ControlType = "SingleLineText"
    }
    help_text = "Name or IP address of the database server."
    label = "Database Server Name"
}

parameter "ProcessTemplate.Database.Name" {
    display_settings = {
        Octopus.ControlType = "SingleLineText"
    }
    help_text = "Name of the database to deploy to."
    label = "Database Name"
}

parameter "ProcessTemplate.Database.Server.Port" {
    display_settings = {
        Octopus.ControlType = "SingleLineText"
    }
    help_text = "Port number that the database server is listening on."
    label = "Database Server Port"
}

step "mysql-create-database-if-not-exists" {
    name = "MySQL - Create Database If Not Exists"

    action {
        action_type = "Octopus.Script"
        properties = {
            createPort = "3306"
            Octopus.Action.RunOnServer = "true"
            Octopus.Action.Script.ScriptBody = <<-EOT
                # Define variables
                $connectionName = "OctopusDeploy"
                
                # Define functions
                function Get-ModuleInstalled {
                    # Define parameters
                    param(
                        $PowerShellModuleName
                    )
                
                    # Check to see if the module is installed
                    if ($null -ne (Get-Module -ListAvailable -Name $PowerShellModuleName)) {
                        # It is installed
                        return $true
                    }
                    else {
                        # Module not installed
                        return $false
                    }
                }
                
                function Install-PowerShellModule {
                    # Define parameters
                    param(
                        $PowerShellModuleName,
                        $LocalModulesPath
                    )
                
                    # Check to see if the package provider has been installed
                    if ((Get-NugetPackageProviderNotInstalled) -ne $false) {
                        # Display that we need the nuget package provider
                        Write-Host "Nuget package provider not found, installing ..."
                        
                        # Install Nuget package provider
                        Install-PackageProvider -Name Nuget -Force
                    }
                
                    # Save the module in the temporary location
                    Save-Module -Name $PowerShellModuleName -Path $LocalModulesPath -Force
                }
                
                function Get-NugetPackageProviderNotInstalled {
                    # See if the nuget package provider has been installed
                    return ($null -eq (Get-PackageProvider -ListAvailable -Name Nuget -ErrorAction SilentlyContinue))
                }
                
                function Get-DatabaseExists {
                    # Define parameters
                    param ($DatabaseName)
                    
                    # Execute query
                    return Invoke-SqlQuery "SHOW DATABASES LIKE '$DatabaseName';" -ConnectionName $connectionName
                }
                
                # Define PowerShell Modules path
                $LocalModules = (New-Item "$PSScriptRoot\Modules" -ItemType Directory -Force).FullName
                $env:PSModulePath = "$LocalModules$([System.IO.Path]::PathSeparator)$env:PSModulePath"
                $PowerShellModuleName = "SimplySql"
                
                # Set secure protocols
                [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor [Net.SecurityProtocolType]::Tls11 -bor [System.Net.SecurityProtocolType]::Tls12
                
                # Check to see if SimplySql module is installed
                if ((Get-ModuleInstalled -PowerShellModuleName $PowerShellModuleName) -ne $true) {
                    # Tell user what we're doing
                    Write-Output "PowerShell module $PowerShellModuleName is not installed, downloading temporary copy ..."
                
                    # Install temporary copy
                    Install-PowerShellModule -PowerShellModuleName $PowerShellModuleName -LocalModulesPath $LocalModules
                }
                
                # Display
                Write-Output "Importing module $PowerShellModuleName ..."
                
                # Check to see if it was downloaded
                if ((Test-Path -Path "$LocalModules\$PowerShellModuleName") -eq $true) {
                    # Import from temp location
                    $PowerShellModuleName = "$LocalModules\$PowerShellModuleName"
                }
                
                # Declare connection string
                $connectionString = "Server=$createMySQLServerName;Port=$createPort;"
                
                # Customize connection string based on authentication method
                switch ($mySqlAuthenticationMethod) {
                    "awsiam" {
                        # Region is part of the RDS endpoint, extract
                        $region = ($createMySQLServerName.Split("."))[2]
                
                        Write-Host "Generating AWS IAM token ..."
                        $createUserPassword = (aws rds generate-db-auth-token --hostname $createMySQLServerName --region $region --port $createPort --username $createUsername)
                        
                        # Append remaining portion of connection string
                        $connectionString += ";Uid=$createUsername;Pwd=`"$createUserPassword`";"
                
                        break
                    }
                
                    "usernamepassword" {
                        # Append remaining portion of connection string
                        $connectionString += ";Uid=$createUsername;Pwd=`"$createUserPassword`";"
                        
                        break    
                    }
                
                    "windowsauthentication" {
                        # Append remaining portion of connection string
                        $connectionString += ";IntegratedSecurity=yes;Uid=$createUsername;"
                
                        break
                    }
                
                    "azuremanagedidentity" {
                        Write-Host "Generating Azure Managed Identity token ..."
                        $token = Invoke-RestMethod -Method GET -Uri "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://ossrdbms-aad.database.windows.net" -Headers @{"MetaData" = "true" }
                
                        $createUserPassword = $token.access_token
                
                        $connectionString += ";Uid=$createUsername;Pwd=`"$createUserPassword`";"
                
                        break
                    }
                
                    "gcpserviceaccount" {
                        # Define header
                        $header = @{ "Metadata-Flavor" = "Google" }
                
                        # Retrieve service accounts
                        $serviceAccounts = Invoke-RestMethod -Method Get -Uri "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/" -Headers $header
                
                        # Results returned in plain text format, get into array and remove empty entries
                        $serviceAccounts = $serviceAccounts.Split([Environment]::NewLine, [StringSplitOptions]::RemoveEmptyEntries)
                
                        # Retreive the specific service account assigned to the VM
                        $serviceAccount = $serviceAccounts | Where-Object { $_.Contains("iam.gserviceaccount.com") }
                
                        if ([string]::IsNullOrWhiteSpace(($createUsername))) {
                            $createUsername = $serviceAccount.SubString(0, $serviceAccount.IndexOf(".gserviceaccount.com"))
                        }
                
                        Write-Host "Generating GCP IAM token ..."
                        # Retrieve token for account
                        $token = Invoke-RestMethod -Method Get -Uri "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/$serviceAccount/token" -Headers $header
                        
                        $createUserPassword = $token.access_token
                        $connectionString += ";Uid=$createUsername;Pwd=`"$createUserPassword`";"
                
                        break
                    }
                }
                
                
                # Import the module
                Import-Module -Name $PowerShellModuleName
                
                
                try {
                    # Connect to MySQL
                    $connectionString = "Server=$createMySQLServerName;Port=$createPort;Uid=$createUsername;Pwd=$createUserPassword;"
                    if ($createUseSSL -eq "True") {
                        # Append to connection string
                        $connectionString += "SslMode=Required;"
                    }
                    else {
                        # Disable ssl
                        $connectionString += "SslMode=none;"
                    }
                    
                    if (![string]::IsNullOrWhitespace($mysqlAdditionalParameters))
                    {
                      foreach ($parameter in $mysqlAdditionalParameters.Split(","))
                      {
                          # Check for delimiter
                          if (!$connectionString.EndsWith(";") -and !$parameter.StartsWith(";"))
                          {
                              # Append delimeter
                              $connectionString +=";"
                          }
                
                          $connectionString += $parameter.Trim()
                      }
                    }
                       
                    Open-MySqlConnection -ConnectionString $connectionString -ConnectionName $connectionName
                
                    # See if database exists
                    $databaseExists = Get-DatabaseExists -DatabaseName $createDatabaseName
                
                    if ($databaseExists.ItemArray.Count -eq 0) {
                        # Create database
                        Write-Output "Creating database $createDatabaseName ..."
                        $executionResult = Invoke-SqlUpdate "CREATE DATABASE $createDatabaseName;" -ConnectionName $connectionName
                
                        # Check result
                        if ($executionResult -ne 1) {
                            # Commit transaction
                            Write-Error "Create schema failed."
                        }
                        else {
                            # See if it was created
                            $databaseExists = Get-DatabaseExists -DatabaseName $createDatabaseName
                            
                            # Check array
                            if ($databaseExists.ItemArray.Count -eq 1) {
                                # Success
                                Write-Output "$createDatabaseName created successfully!"
                            }
                            else {
                                # Failed
                                Write-Error "$createDatabaseName was not created!"
                            }
                        }
                    }
                    else {
                        # Display message
                        Write-Output "Database $createDatabaseName already exists."
                    }
                }
                finally {
                	# Close connection if open
                    if ((Test-SqlConnection -ConnectionName $connectionName) -eq $true)
                    {
                    	Close-SqlConnection -ConnectionName $connectionName
                    }
                }
                EOT
            Octopus.Action.Script.ScriptSource = "Inline"
            Octopus.Action.Script.Syntax = "PowerShell"
        }
        worker_pool_variable = "#{ProcessTemplate.WorkerPool}"

        community_action_template_snapshot {
            id = "CommunityActionTemplates-523"
            version = 9

            parameter "createMySQLServerName" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Hostname (or IP) of the MySQL database server."
                label = "Server"
                default_value = ""
            }

            parameter "createUsername" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Username to use for the connection"
                label = "Username"
                default_value = ""
            }

            parameter "createUserPassword" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = "Password for the user account"
                label = "Password"
                default_value = ""
            }

            parameter "createDatabaseName" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Name of the database to create"
                label = "Database Name"
                default_value = ""
            }

            parameter "createPort" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Port for the database instance."
                label = "Port"
                default_value = "3306"
            }

            parameter "createUseSSL" {
                display_settings = {
                    Octopus.ControlType = "Checkbox"
                }
                help_text = "Check this box to force the use of SSL."
                label = "Use SSL"
                default_value = ""
            }

            parameter "mySqlAuthenticationMethod" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        awsiam|AWS IAM
                        usernamepassword|Username/password
                        windowsauthentication|Windows Authentication
                        azuremanagedidentity|Azure Managed Identity
                        gcpserviceaccount|GCP IAM
                        EOT
                }
                help_text = "Authentication method used to connect with MySQL. Options include standard Username/Password, Windows Authentication, [AWS IAM Authentication](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.html), [Azure Managed Identity](https://docs.microsoft.com/en-us/azure/mysql/single-server/how-to-connect-with-managed-identity), and [Google Cloud IAM for Cloud SQL ](https://cloud.google.com/sql/docs/mysql/iam-overview)"
                label = "MySQL Authentication Method"
                default_value = ""
            }

            parameter "mysqlAdditionalParameters" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "A comma-delimited list of additional parameters to add to the connection string.  ex `AllowPublicKeyRetrieval=True`"
                label = "Additional connection string parameters"
                default_value = ""
            }
        }
    }
}

step "mysql-create-user-if-not-exists" {
    name = "MySQL - Create User If Not Exists"

    action {
        action_type = "Octopus.Script"
        properties = {
            createMySQLServerPort = "3306"
            Octopus.Action.RunOnServer = "true"
            Octopus.Action.Script.ScriptBody = <<-EOT
                # Define variables
                $connectionName = "OctopusDeploy"
                
                # Define functions
                function Get-ModuleInstalled
                {
                    # Define parameters
                    param(
                        $PowerShellModuleName
                    )
                
                    # Check to see if the module is installed
                    if ($null -ne (Get-Module -ListAvailable -Name $PowerShellModuleName))
                    {
                        # It is installed
                        return $true
                    }
                    else
                    {
                        # Module not installed
                        return $false
                    }
                }
                
                function Install-PowerShellModule
                {
                    # Define parameters
                    param(
                        $PowerShellModuleName,
                        $LocalModulesPath
                    )
                
                	# Check to see if the package provider has been installed
                    if ((Get-NugetPackageProviderNotInstalled) -ne $false)
                    {
                    	# Display that we need the nuget package provider
                        Write-Host "Nuget package provider not found, installing ..."
                        
                        # Install Nuget package provider
                        Install-PackageProvider -Name Nuget -Force
                    }
                
                	# Save the module in the temporary location
                    Save-Module -Name $PowerShellModuleName -Path $LocalModulesPath -Force
                }
                
                function Get-NugetPackageProviderNotInstalled
                {
                	# See if the nuget package provider has been installed
                    return ($null -eq (Get-PackageProvider -ListAvailable -Name Nuget -ErrorAction SilentlyContinue))
                }
                
                function Get-UserExists
                {
                	# Define parameters
                    param ($Hostname,
                    $Username)
                    
                	# Execute query
                    return Invoke-SqlQuery "SELECT * FROM mysql.user WHERE Host = '$Hostname' AND User = '$Username';" -ConnectionName $connectionName
                }
                
                # Define PowerShell Modules path
                $LocalModules = (New-Item "$PSScriptRoot\Modules" -ItemType Directory -Force).FullName
                $env:PSModulePath = "$LocalModules$([System.IO.Path]::PathSeparator)$env:PSModulePath"
                $PowerShellModuleName = "SimplySql"
                
                # Set secure protocols
                [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor [Net.SecurityProtocolType]::Tls11 -bor [System.Net.SecurityProtocolType]::Tls12
                
                # Check to see if SimplySql module is installed
                if ((Get-ModuleInstalled -PowerShellModuleName $PowerShellModuleName) -ne $true)
                {
                    # Tell user what we're doing
                    Write-Output "PowerShell module $PowerShellModuleName is not installed, downloading temporary copy ..."
                
                    # Install temporary copy
                    Install-PowerShellModule -PowerShellModuleName $PowerShellModuleName -LocalModulesPath $LocalModules
                }
                
                # Display
                Write-Output "Importing module $PowerShellModuleName ..."
                
                # Check to see if it was downloaded
                if ((Test-Path -Path "$LocalModules\$PowerShellModuleName") -eq $true)
                {
                	# Use specific location
                    $PowerShellModuleName = "$LocalModules\$PowerShellModuleName"
                }
                
                # Declare connection string
                $connectionString = "Server=$createMySQLServerName;Port=$createPort;"
                $connectionString = "Server=$createMySQLServerName;Port=$createMySQLServerPort;Uid=$createLoginWithAddUserRights;Pwd=$createLoginPasswordWithAddUserRights;"
                
                
                # Customize connection string based on authentication method
                switch ($mySqlAuthenticationMethod) {
                    "awsiam" {
                        # Region is part of the RDS endpoint, extract
                        $region = ($createMySQLServerName.Split("."))[2]
                
                        Write-Host "Generating AWS IAM token ..."
                        $createLoginPasswordWithAddUserRights = (aws rds generate-db-auth-token --hostname $createMySQLServerName --region $region --port $createPort --username $createLoginWithAddUserRights)
                        
                        # Append remaining portion of connection string
                        $connectionString += ";Uid=$createLoginWithAddUserRights;Pwd=`"$createLoginPasswordWithAddUserRights`";"
                
                        break
                    }
                
                    "usernamepassword" {
                        # Append remaining portion of connection string
                        $connectionString += ";Uid=$createLoginWithAddUserRights;Pwd=`"$createLoginPasswordWithAddUserRights`";"
                        
                        break    
                    }
                
                    "windowsauthentication" {
                        # Append remaining portion of connection string
                        $connectionString += ";IntegratedSecurity=yes;Uid=$createLoginWithAddUserRights;"
                
                        break
                    }
                
                    "azuremanagedidentity" {
                        Write-Host "Generating Azure Managed Identity token ..."
                        $token = Invoke-RestMethod -Method GET -Uri "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://ossrdbms-aad.database.windows.net" -Headers @{"MetaData" = "true" }
                
                        $createLoginPasswordWithAddUserRights = $token.access_token
                
                        $connectionString += ";Uid=$createLoginWithAddUserRights;Pwd=`"$createLoginPasswordWithAddUserRights`";"
                
                        break
                    }
                
                    "gcpserviceaccount" {
                        # Define header
                        $header = @{ "Metadata-Flavor" = "Google" }
                
                        # Retrieve service accounts
                        $serviceAccounts = Invoke-RestMethod -Method Get -Uri "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/" -Headers $header
                
                        # Results returned in plain text format, get into array and remove empty entries
                        $serviceAccounts = $serviceAccounts.Split([Environment]::NewLine, [StringSplitOptions]::RemoveEmptyEntries)
                
                        # Retreive the specific service account assigned to the VM
                        $serviceAccount = $serviceAccounts | Where-Object { $_.Contains("iam.gserviceaccount.com") }
                
                        if ([string]::IsNullOrWhiteSpace(($createLoginWithAddUserRights)))
                        {
                                $createLoginWithAddUserRights = $serviceAccount.SubString(0, $serviceAccount.IndexOf(".gserviceaccount.com"))
                        }
                
                        Write-Host "Generating GCP IAM token ..."
                        # Retrieve token for account
                        $token = Invoke-RestMethod -Method Get -Uri "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/$serviceAccount/token" -Headers $header
                        
                        $createLoginPasswordWithAddUserRights = $token.access_token
                        $connectionString += ";Uid=$createLoginWithAddUserRights;Pwd=`"$createLoginPasswordWithAddUserRights`";"
                
                        break
                    }
                }
                
                # Import the module
                Import-Module -Name $PowerShellModuleName
                
                try
                {
                	# Connect to MySQL
                    if ($createUseSSL -eq "True")
                    {
                    	# Append to connection string
                        $connectionString += "SslMode=Required;"
                    }
                    else
                    {
                    	# Disable ssl
                        $connectionString += "SslMode=none;"
                    }
                
                    if (![string]::IsNullOrWhitespace($mysqlAdditionalParameters))
                    {
                      foreach ($parameter in $mysqlAdditionalParameters.Split(","))
                      {
                          # Check for delimiter
                          if (!$connectionString.EndsWith(";") -and !$parameter.StartsWith(";"))
                          {
                              # Append delimeter
                              $connectionString +=";"
                          }
                
                          $connectionString += $parameter.Trim()
                      }
                    }
                
                	Open-MySqlConnection -ConnectionString $connectionString -ConnectionName $connectionName
                    
                    # See if database exists
                    $userExists = Get-UserExists -Hostname $createUserHostname -Username $createNewUsername
                
                    if ($userExists -eq $null)
                    {
                        # Create database
                        Write-Output "Creating user $createNewUsername ..."
                        $executionResults = Invoke-SqlUpdate "CREATE USER '$createNewUsername'@'$createUserHostname' IDENTIFIED BY '$createNewUserPassword';" -ConnectionName $connectionName
                
                        # See if it was created
                        $userExists = Get-UserExists -Hostname $createUserHostname -Username $createNewUsername
                            
                        # Check array
                        if ($userExists -ne $null)
                        {
                            # Success
                            Write-Output "$createNewUsername created successfully!"
                        }
                        else
                        {
                            # Failed
                            Write-Error "$createNewUsername was not created!"
                        }
                    }
                    else
                    {
                    	# Display message
                        Write-Output "User $createNewUsername on $createUserHostname already exists."
                    }
                }
                finally
                {
                	# Close connection if open
                    if ((Test-SqlConnection -ConnectionName $connectionName) -eq $true)
                    {
                    	Close-SqlConnection -ConnectionName $connectionName
                    }
                }
                
                EOT
            Octopus.Action.Script.ScriptSource = "Inline"
            Octopus.Action.Script.Syntax = "PowerShell"
        }
        worker_pool_variable = "#{ProcessTemplate.WorkerPool}"

        community_action_template_snapshot {
            id = "CommunityActionTemplates-548"
            version = 7

            parameter "createMySQLServerName" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Host name of the MySQL server"
                label = "MySQL Server"
                default_value = ""
            }

            parameter "createMySQLServerPort" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Port number the MySQL server listens on."
                label = "Port"
                default_value = "3306"
            }

            parameter "createLoginWithAddUserRights" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Login name of a user with rights to create user accounts."
                label = "Login name"
                default_value = ""
            }

            parameter "createLoginPasswordWithAddUserRights" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = "Password Login name."
                label = "Login Password"
                default_value = ""
            }

            parameter "createNewUsername" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Name of the new user account to create."
                label = "New user name"
                default_value = ""
            }

            parameter "createNewUserPassword" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = "Password for the new user account."
                label = "New user password"
                default_value = ""
            }

            parameter "createUserHostname" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Host name that the new user account is allowed to login from.  Enter % to allow the account to connect from anywhere."
                label = "New user host name"
                default_value = ""
            }

            parameter "createUseSSL" {
                display_settings = {
                    Octopus.ControlType = "Checkbox"
                }
                help_text = "Check this box to force the use of SSL."
                label = "Use SSL"
                default_value = ""
            }

            parameter "mySqlAuthenticationMethod" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        awsiam|AWS IAM
                        usernamepassword|Username/password
                        windowsauthentication|Windows Authentication
                        azuremanagedidentity|Azure Managed Identity
                        gcpserviceaccount|GCP IAM
                        EOT
                }
                help_text = "Authentication method used to connect with MySQL. Options include standard Username/Password, Windows Authentication, [AWS IAM Authentication](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.html), [Azure Managed Identity](https://docs.microsoft.com/en-us/azure/mysql/single-server/how-to-connect-with-managed-identity), and [Google Cloud IAM for Cloud SQL ](https://cloud.google.com/sql/docs/mysql/iam-overview)"
                label = "MySQL Authentication Method"
                default_value = ""
            }

            parameter "mysqlAdditionalParameters" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "A comma-delimited list of additional parameters to add to the connection string.  ex `AllowPublicKeyRetrieval=True`"
                label = "Additional connection string parameters"
                default_value = ""
            }
        }
    }
}

step "flyway-database-migrations-info" {
    name = "Flyway Database Migrations - Info"

    action {
        action_type = "Octopus.Script"
        properties = {
            Flyway.Authentication.Method = "#{ProcessTemplate.Database.Authentication.Method}"
            Flyway.Command.BaseLineOnMigrate = "false"
            Flyway.Command.FailOnDrift = "true"
            Flyway.Command.OutOfOrder = "false"
            Flyway.Command.SkipExecutingMigrations = "false"
            Flyway.Command.Target = "latest"
            Flyway.Command.Value = "info"
            Flyway.Package.Value = "ProcessTemplate.Flyway.Package"
            Octopus.Action.EnabledFeatures = "Octopus.Features.SelectPowerShellEditionForWindows"
            Octopus.Action.PowerShell.Edition = "Core"
            Octopus.Action.RunOnServer = "true"
            Octopus.Action.Script.ScriptBody = <<-EOT
                $VerboseActionPreference="Continue"
                
                function Get-FlywayExecutablePath
                {
                	param (
                    	$providedPath
                    )
                    
                    if ([string]::IsNullOrWhiteSpace($providedPath) -eq $false)
                    {
                    	Write-Host "The executable path was provided, testing to see if it is absolute or relative"
                		if ([IO.Path]::IsPathRooted($providedPath))
                        {
                        	Write-Host "The provided path is absolute, using that"
                            
                        	return $providedPath
                        }
                        
                        Write-Host "The provided path was relative, combining $(Get-Location) with $providedPath"
                        return Join-Path $(Get-Location) $providedPath
                    }
                    
                    Write-Host "Checking to see if we are currently running on Linux"
                    if ($IsLinux)    
                    {
                    	Write-Host "Currently running on Linux"
                    	Write-Host "Checking to see if flyway was included with the package"
                    	if (Test-Path "./flyway")
                        {
                        	Write-Host "It was, using that version of flyway"
                        	return "flyway"
                        }
                        
                        Write-Host "Testing to see if we are on an execution container with /flyway/flyway as the path"
                    	if (Test-Path "/flyway/flyway")
                        {
                        	Write-Host "We are, using /flyway/flyway"
                        	return "/flyway/flyway"
                        }               
                    }
                    
                    Write-Host "Currently running on Windows"
                    
                    Write-Host "Testing to see if flyway.cmd was included with the package"
                    if (Test-Path ".\flyway.cmd")
                    {
                    	Write-Host "It was, using that version."
                    	return ".\flyway.cmd"
                    }
                    
                    Write-Host "Testing to see if flyway can be found in the env path"
                    $flywayExecutable = (Get-Command "flyway" -ErrorAction SilentlyContinue)
                    if ($null -ne $flywayExecutable)
                    {
                    	Write-Host "The flyway folder is part of the environment path"
                        return $flywayExecutable.Source
                    }
                    
                    Fail-Step "Unable to find flyway executable.  Please include it as part of the package, or provide the path to it."
                }
                
                function Test-AddParameterToCommandline
                {
                	param (
                    	$acceptedCommands,
                        $selectedCommand,
                        $parameterValue,
                        $defaultValue,
                        $parameterName
                    )
                    
                    if ([string]::IsNullOrWhiteSpace($parameterValue) -eq $true)
                    {    	
                    	Write-Verbose "$parameterName is empty, returning false"
                    	return $false
                    }
                    
                    if ([string]::IsNullOrWhiteSpace($defaultValue) -eq $false -and $parameterValue.ToLower().Trim() -eq $defaultValue.ToLower().Trim())
                    {
                    	Write-Verbose "$parameterName is matches the default value, returning false"
                    	return $false
                    }
                    
                    if ([string]::IsNullOrWhiteSpace($acceptedCommands) -eq $true -or $acceptedCommands -eq "any")
                    {
                    	Write-Verbose "$parameterName has a value and this is for any command, returning true"
                    	return $true
                    }
                    
                    $acceptedCommandArray = $acceptedCommands -split ","
                    foreach ($command in $acceptedCommandArray)
                    {
                    	if ($command.ToLower().Trim() -eq $selectedCommand.ToLower().Trim())
                        {
                        	Write-Verbose "$parameterName has a value and the current command $selectedCommand matches the accepted command $command, returning true"
                        	return $true
                        }
                    }
                    
                    Write-Verbose "$parameterName has a value but is not accepted in the current command, returning false"
                    return $false
                }
                
                function Get-ParsedUrl
                {
                	# Define parameters
                    param (
                    	$ConnectionUrl
                    )
                    
                    # Remove the 'jdbc:' portion from the $ConnectionUrl parameter
                    $ConnectionUrl = $ConnectionUrl.ToLower().Replace("jdbc:", "")
                    
                    # Parse and return the url
                    return [System.Uri]$ConnectionUrl
                }
                
                # Declaring the path to the NuGet package
                $flywayPackagePath = $OctopusParameters["Octopus.Action.Package[Flyway.Package.Value].ExtractedPath"]
                $flywayUrl = $OctopusParameters["Flyway.Target.Url"]
                $flywayUser = $OctopusParameters["Flyway.Database.User"]
                $flywayUserPassword = $OctopusParameters["Flyway.Database.User.Password"]
                $flywayCommand = $OctopusParameters["Flyway.Command.Value"]
                $flywayLicenseKey = $OctopusParameters["Flyway.License.Key"]
                $flywayLicenseEmail = $OctopusParameters["Flyway.Email.Address"]
                $flywayLicensePAT = $OctopusParameters["Flyway.PersonalAccessToken"]
                $flywayExecutablePath = $OctopusParameters["Flyway.Executable.Path"]
                $flywaySchemas = $OctopusParameters["Flyway.Command.Schemas"]
                $flywayTarget = $OctopusParameters["Flyway.Command.Target"]
                $flywayInfoSinceDate = $OctopusParameters["Flyway.Command.InfoSinceDate"]
                $flywayInfoSinceVersion = $OctopusParameters["Flyway.Command.InfoSinceVersion"]
                $flywayLicensedEdition = $OctopusParameters["Flyway.License.Version"]
                $flywayCherryPick = $OctopusParameters["Flyway.Command.CherryPick"]
                $flywayOutOfOrder = $OctopusParameters["Flyway.Command.OutOfOrder"]
                $flywaySkipExecutingMigrations = $OctopusParameters["Flyway.Command.SkipExecutingMigrations"]
                $flywayPlaceHolders = $OctopusParameters["Flyway.Command.PlaceHolders"]
                $flywayBaseLineVersion = $OctopusParameters["Flyway.Command.BaselineVersion"]
                $flywayBaselineDescription = $OctopusParameters["Flyway.Command.BaselineDescription"]
                $flywayAuthenticationMethod = $OctopusParameters["Flyway.Authentication.Method"]
                $flywayLocations = $OctopusParameters["Flyway.Command.Locations"]
                $flywayAdditionalArguments = $OctopusParameters["Flyway.Additional.Arguments"]
                $flywayStepName = $OctopusParameters["Octopus.Action.StepName"]
                $flywayEnvironment = $OctopusParameters["Octopus.Environment.Name"]
                $flywayCheckBuildUrl = $OctopusParameters["Flyway.Command.CheckBuildUrl"]
                $flywayCheckBuildUsername = $OctopusParameters["Flyway.Database.Check.User"]
                $flywayCheckBuildPassword = $OctopusParameters["Flyway.Database.Check.User.Password"]
                $flywayBaselineOnMigrate = $OctopusParameters["Flyway.Command.BaseLineOnMigrate"]
                $flywaySnapshotFileName = $OctopusParameters["Flyway.Command.Snapshot.FileName"]
                $flywayCheckFailOnDrift = $OctopusParameters["Flyway.Command.FailOnDrift"]
                
                if ([string]::IsNullOrWhitespace($flywayLocations))
                {
                	$flywayLocations = "filesystem:$flywayPackagePath"
                }
                
                
                # Logging for troubleshooting
                Write-Host "*******************************************"
                Write-Host "Logging variables:"
                Write-Host " - - - - - - - - - - - - - - - - - - - - -"
                Write-Host "PackagePath: $flywayPackagePath"
                Write-Host "Flyway Executable Path: $flywayExecutablePath"
                Write-Host "Flyway Command: $flywayCommand"
                Write-Host "-url: $flywayUrl"
                Write-Host "-user: $flywayUser"
                Write-Host "-schemas: $flywaySchemas"
                Write-Host "-target: $flywayTarget"
                Write-Host "-cherryPick: $flywayCherryPick"
                Write-Host "-outOfOrder: $flywayOutOfOrder"
                Write-Host "-skipExecutingMigrations: $flywaySkipExecutingMigrations"
                Write-Host "-infoSinceDate: $flywayInfoSinceDate"
                Write-Host "-infoSinceVersion: $flywayInfoSinceVersion"
                Write-Host "-baselineOnMigrate: $flywayBaselineOnMigrate"
                Write-Host "-baselineVersion: $flywayBaselineVersion"
                Write-Host "-baselineDescription: $flywayBaselineDescription"
                Write-Host "-locations: $flywayLocations"
                Write-Host "-check.BuildUrl: $flywayCheckBuildUrl"
                Write-Host "-check.failOnDrift: $flywayCheckFailOnDrift"
                Write-Host "-snapshot.FileName OR check.DeployedSnapshot: $flywaySnapshotFileName"
                Write-Host "Additional Arguments: $flywayAdditionalArguments"
                Write-Host "placeHolders: $flywayPlaceHolders"
                Write-Host "*******************************************"
                
                if ($null -eq $IsWindows) {
                    Write-Host "Determining Operating System..."
                    $IsWindows = ([System.Environment]::OSVersion.Platform -eq "Win32NT")
                    $IsLinux = ([System.Environment]::OSVersion.Platform -eq "Unix")
                }
                
                Write-Host "Setting execution location to: $flywayPackagePath"
                Set-Location $flywayPackagePath
                
                $flywayCmd = Get-FlywayExecutablePath -providedPath $flywayExecutablePath
                
                $commandToUse = $flywayCommand
                if ($flywayCommand -eq "migrate dry run")
                {
                	$commandToUse = "migrate"
                }
                
                if ($flywayCommand -eq "check dry run" -or $flywayCommand -eq "check changes" -or $flywayCommand -eq "check drift")
                {
                	$commandToUse = "check"
                }
                
                $arguments = @(
                	$commandToUse    
                )
                
                if ($flywayCommand -eq "check dry run")
                {
                	$arguments += "-dryrun"
                }
                
                if ($flywayCommand -eq "check changes")
                {
                	$arguments += "-changes"
                    $arguments += "-dryrun"
                }
                
                if ($flywayCommand -eq "check drift")
                {
                	$arguments += "-drift"
                }
                
                # Deteremine authentication method
                switch ($flywayAuthenticationMethod)
                {
                	"awsiam"
                    {
                		# Check to see if OS is Windows and running in a container
                        if ($IsWindows -and $env:DOTNET_RUNNING_IN_CONTAINER)
                        {
                        	throw "IAM Role authentication is not supported in a Windows container."
                        }
                
                		# Get parsed connection string url
                        $parsedUrl = Get-ParsedUrl -ConnectionUrl $flywayUrl
                        
                        # Region is part of the RDS endpoint, extract
                        $region = ($parsedUrl.Host.Split("."))[2]
                
                		Write-Host "Generating AWS IAM token ..."
                		$flywayUserPassword = (aws rds generate-db-auth-token --hostname $parsedUrl.Host --region $region --port $parsedUrl.Port --username $flywayUser)
                
                		$arguments += "-user=`"$flywayUser`""
                    	$arguments += "-password=`"$flywayUserPassword`""
                
                		break
                    }
                	"azuremanagedidentity"
                    {
                		# Check to see if OS is Windows and running in a container
                        if ($IsWindows -and $env:DOTNET_RUNNING_IN_CONTAINER)
                        {
                        	throw "Azure Managed Identity is not supported in a Windows container."
                        }
                        
                        # SQL Server driver doesn't assign password
                        if (!$flywayUrl.ToLower().Contains("jdbc:sqlserver:"))
                        {        
                          # Get login token
                          Write-Host "Generating Azure Managed Identity token ..."
                          $token = Invoke-RestMethod -Method GET -Uri "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://ossrdbms-aad.database.windows.net" -Headers @{"MetaData" = "true"} -UseBasicParsing
                
                          $flywayUserPassword = $token.access_token
                          $arguments += "-password=`"$flywayUserPassword`""
                          $arguments += "-user=`"$flywayUser`""
                        }
                        else
                        {
                            
                			# Check to see if the querstring parameter for Azure Managed Identity is present
                            if (!$flywayUrl.ToLower().Contains("authentication=activedirectorymsi"))
                            {
                                # Add the authentication piece to the jdbc url
                                if (!$flywayUrl.EndsWith(";"))
                                {
                                	# Add the separator
                                    $flywayUrl += ";"
                                }
                                
                                # Add authentication piece
                                $flywayUrl += "Authentication=ActiveDirectoryMSI"
                            }
                        }
                        
                        break
                    }
                    "gcpserviceaccount"
                    {
                		# Check to see if OS is Windows and running in a container
                        if ($IsWindows -and $env:DOTNET_RUNNING_IN_CONTAINER)
                        {
                        	throw "GCP Service Account authentication is not supported in a Windows container."
                        }
                    
                        # Define header
                        $header = @{ "Metadata-Flavor" = "Google"}
                
                        # Retrieve service accounts
                        $serviceAccounts = Invoke-RestMethod -Method Get -Uri "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/" -Headers $header -UseBasicParsing
                
                        # Results returned in plain text format, get into array and remove empty entries
                        $serviceAccounts = $serviceAccounts.Split([Environment]::NewLine, [StringSplitOptions]::RemoveEmptyEntries)
                
                        # Retreive the specific service account assigned to the VM
                        $serviceAccount = $serviceAccounts | Where-Object {$_.ToLower().Contains("iam.gserviceaccount.com") }
                
                		Write-Host "Generating GCP IAM token ..."
                        # Retrieve token for account
                        $token = Invoke-RestMethod -Method Get -Uri "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/$serviceAccount/token" -Headers $header -UseBasicParsing
                        
                        $flywayUserPassword = $token.access_token
                        
                        $arguments += "-user=`"$flywayUser`""
                        $arguments += "-password=`"$flywayUserPassword`""
                        #$env:FLYWAY_PASSWORD = $flywayUserPassword
                        
                        break
                    }   
                    "usernamepassword"
                    {
                    	# Add password
                        Write-Host "Testing for parameters that can be applied to any command"
                        if (Test-AddParameterToCommandline -parameterValue $flywayUser -acceptedCommands "any" -selectedCommand $flywayCommand -parameterName "-user")
                        {
                            Write-Host "User provided, adding user and password command line argument"
                            $arguments += "-user=`"$flywayUser`""
                            $arguments += "-password=`"$flywayUserPassword`""
                        }
                        
                        break
                    }
                    "windowsauthentication"
                    {
                    	# Display to the user they've selected windows authentication.  Though this is dictated by the jdbc url, this is added to make sure the user knows that's what is
                        # being used
                        Write-Host "Using Windows Authentication"
                        
                        # Check for integratedauthentication=true in url
                        if (!$flywayUrl.ToLower().Contains("integratedsecurity=true"))
                        {
                        	# Check to see if the connection url ends with a ;
                            if (!$flywayUrl.EndsWith(";"))
                            {
                            	# Add the ;
                                $flywayUrl += ";"
                            }
                            
                            $flywayUrl += "integratedSecurity=true;"
                        }
                        break
                    }
                }
                
                $arguments += "-url=`"$flywayUrl`""
                $arguments += "-locations=`"$flywayLocations`""
                
                if (Test-AddParameterToCommandline -parameterValue $flywaySchemas -acceptedCommands "any" -selectedCommand $flywayCommand -parameterName "-schemas")
                {
                	Write-Host "Schemas provided, adding schemas command line argument"
                	$arguments += "-schemas=`"$flywaySchemas`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayLicenseKey -acceptedCommands "any" -selectedCommand $flywayCommand -parameterName "-licenseKey")
                {
                	Write-Host "License key provided, adding -licenseKey command line argument"
                    Write-Host "*****WARNING***** Use of the License Key has been deprecated by Redgate and will be removed in future versions, use the Personal Access Token method instead."
                	$arguments += "-licenseKey=`"$flywayLicenseKey`""                  
                }
                
                if (![string]::IsNullOrWhiteSpace($flywayLicenseEmail) -and ![string]::IsNullOrWhiteSpace($flywayLicensePAT))
                {
                    if (Test-AddParameterToCommandline -parameterValue $flywayLicensePAT -acceptedCommands "any" -selectedCommand $flywayCommand -parameterName "-token")
                    {
                        Write-Host "Personal Access Token provided, adding -email and -token command line arguments"
                        $arguments += @("-email=`"$flywayLicenseEmail`"", "-token=`"$flywayLicensePAT`"")
                    }
                }
                
                Write-Host "Finished testing for parameters that can be applied to any command, moving onto command specific parameters"
                
                if (Test-AddParameterToCommandline -parameterValue $flywayCherryPick -acceptedCommands "migrate,info,validate,check" -selectedCommand $flywayCommand -parameterName "-cherryPick")
                {
                	Write-Host "Cherry pick provided, adding cherry pick command line argument"
                	$arguments += "-cherryPick=`"$flywayCherryPick`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayOutOfOrder -defaultValue "false" -acceptedCommands "migrate,info,validate,check" -selectedCommand $commandToUse -parameterName "-outOfOrder")
                {
                	Write-Host "Out of order is not false, adding out of order command line argument"
                	$arguments += "-outOfOrder=`"$flywayOutOfOrder`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayPlaceHolders -acceptedCommands "migrate,info,validate,undo,repair,check" -selectedCommand $commandToUse -parameterName "-placeHolders")
                {
                	Write-Host "Placeholder parameter provided, adding them to the command line arguments"
                    
                    $placeHolderValueList = @(($flywayPlaceHolders -Split "`n").Trim())
                    foreach ($placeHolder in $placeHolderValueList)
                    {
                    	$placeHolderSplit = $placeHolder -Split "::"
                        $placeHolderKey = $placeHolderSplit[0]
                        $placeHolderValue = $placeHolderSplit[1]
                        Write-Host "Adding -placeHolders.$placeHolderKey = $placeHolderValue to the argument list"
                        
                        $arguments += "-placeholders.$placeHolderKey=`"$placeHolderValue`""    
                    }   	
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayTarget -acceptedCommands "migrate,info,validate,undo,check" -selectedCommand $commandToUse -parameterName "-target")
                {
                	Write-Host "Target provided, adding target command line argument"
                
                	if ($flywayTarget.ToLower().Trim() -eq "latest" -and $flywayCommand -eq "undo")
                	{
                		Write-Host "The current target is latest, but the command is undo, changing the target to be current"
                		$flywayTarget = "current"
                	}
                
                	$arguments += "-target=`"$flywayTarget`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywaySkipExecutingMigrations -defaultValue "false" -acceptedCommands "migrate" -selectedCommand $flywayCommand -parameterName "-skipExecutingMigrations")
                {
                	Write-Host "Skip executing migrations is not false, adding skip executing migrations command line argument"
                	$arguments += "-skipExecutingMigrations=`"$flywaySkipExecutingMigrations`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayBaselineOnMigrate -defaultValue "false" -acceptedCommands "migrate" -selectedCommand $flywayCommand -parameterName "-baselineOnMigrate")
                {
                	Write-Host "Baseline on migrate is not false, adding the baseline on migrate argument"
                	$arguments += "-baselineOnMigrate=`"$flywayBaselineOnMigrate`""    
                    
                    if (Test-AddParameterToCommandline -parameterValue $flywayBaselineVersion -acceptedCommands "migrate" -selectedCommand $flywayCommand -parameterName "-baselineVersion")
                    {
                    	Write-Host "Baseline version has been specified, adding baseline version argument"
                		$arguments += "-baselineVersion=`"$flywayBaselineVersion`""  
                    }
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayBaselineVersion -acceptedCommands "baseline" -selectedCommand $flywayCommand -parameterName "-baselineVersion")
                {
                	Write-Host "Doing a baseline, adding baseline version and description"
                	$arguments += "-baselineVersion=`"$flywayBaselineVersion`""    
                    $arguments += "-baselineDescription=`"$flywayBaselineDescription`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayInfoSinceDate -acceptedCommands "info" -selectedCommand $flywayCommand -parameterName "-infoSinceDate")
                {
                	Write-Host "Info since date has been provided, adding that to the command line arguments"
                	$arguments += "-infoSinceDate=`"$flywayInfoSinceDate`""
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayInfoSinceVersion -acceptedCommands "info" -selectedCommand $flywayCommand -parameterName "-infoSinceVersion")
                {
                	Write-Host "Info since version has been provided, adding that to the command line arguments"
                	$arguments += "-infoSinceVersion=`"$flywayInfoSinceVersion`""
                } 
                
                if (Test-AddParameterToCommandline -parameterValue $flywaySnapshotFileName -acceptedCommands "snapshot" -selectedCommand $commandToUse -parameterName "-snapshot.filename")
                {
                	Write-Host "Snapshot filename has been provided, adding that to the command line arguments"
                    $folderName = Split-Path -Parent $flywaySnapshotFileName
                    if ((test-path $folderName) -eq $false)
                    {
                    	New-Item $folderName -ItemType Directory
                    }
                    $arguments += "-snapshot.filename=`"$flywaySnapshotFileName`""
                }
                
                $snapshotFileNameforCheckProvided = $false
                if (Test-AddParameterToCommandline -parameterValue $flywaySnapshotFileName -acceptedCommands "check" -selectedCommand $commandToUse -parameterName "-check.deployedSnapshot")
                {
                	Write-Host "Snapshot filename has been provided for the check command, adding that to the command line arguments"
                    $folderName = Split-Path -Parent $flywaySnapshotFileName
                    if ((test-path $folderName) -eq $false)
                    {
                    	New-Item $folderName -ItemType Directory
                    }
                    $arguments += "-check.deployedSnapshot=`"$flywaySnapshotFileName`""
                    $snapshotFileNameforCheckProvided = $true
                }
                
                if ((Test-AddParameterToCommandline -parameterValue $flywayCheckBuildUrl -acceptedCommands "check" -selectedCommand $commandToUse -parameterName "-check.buildUrl") -eq $true -and $snapshotFileNameforCheckProvided -eq $false)
                {
                	Write-Host "Check build URL has been provided, adding that to the command line arguments"
                	$arguments += "-check.buildUrl=`"$flywayCheckBuildUrl`""
                }
                
                Write-Host "Checking to see if the check username and password were supplied"
                if ((Test-AddParameterToCommandline -parameterValue $flywayCheckBuildUsername -acceptedCommands "check" -selectedCommand $commandToUse -parameterName "-user")  -eq $true -and $snapshotFileNameforCheckProvided -eq $false)
                {
                	Write-Host "Check User provided, adding check user and check password command line argument"
                	$arguments += "-check.buildUser=`"$flywayCheckBuildUsername`""
                	$arguments += "-check.buildPassword=`"$flywayCheckBuildPassword`""
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayCheckFailOnDrift -acceptedCommands "check drift" -selectedCommand $flywayCommand -parameterName "-check.failOnDrift")
                {
                	Write-Host "Doing a check drift command, adding the fail on drift"
                	$arguments += "-check.failOnDrift=`"$flywayCheckFailOnDrift`""
                }
                
                
                Write-Host "Finished checking for command specific parameters, moving onto execution"
                $dryRunOutputFile = ""
                
                if ($flywayCommand -eq "migrate dry run")
                {
                	$dryRunOutputFile = Join-Path $(Get-Location) "dryRunOutput"
                    Write-Host "Adding the argument dryRunOutput so Flyway will perform a dry run and not an actual migration."
                    $arguments += "-dryRunOutput=`"$dryRunOutputFile`""
                }
                
                # Check to see if there's any additional arguments to add
                if (![string]::IsNullOrWhitespace($flywayAdditionalArguments))
                {
                	# Split on space
                    $flywayAdditionalArgumentsArray = ($flywayAdditionalArguments.Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries))
                
                    # Loop through array
                    foreach ($newArgument in $flywayAdditionalArgumentsArray)
                    {
                    	# Add the arguments
                    	$arguments += $newArgument
                    }
                }
                
                # Display what's going to be run
                if (![string]::IsNullOrWhitespace($flywayUserPassword))
                {
                    $flywayDisplayArguments = $arguments.PSObject.Copy()
                    $arrayIndex = 0
                    for ($i = 0; $i -lt $flywayDisplayArguments.Count; $i++)
                    {
                        if ($null -ne $flywayDisplayArguments[$i])
                        {
                            if ($flywayDisplayArguments[$i].Contains($flywayUserPassword))
                            {
                                $flywayDisplayArguments[$i] = $flywayDisplayArguments[$i].Replace($flywayUserPassword, "****")
                            }
                        }
                    }
                
                    Write-Host "Executing the following command: $flywayCmd $flywayDisplayArguments"
                }
                else
                {
                    Write-Host "Executing the following command: $flywayCmd $arguments"
                }
                
                # Attempt to find driver path for java
                $driverPath = (Get-ChildItem -Path (Get-ChildItem -Path $flywayCmd).Directory -Recurse | Where-Object {$_.PSIsContainer -eq $true -and $_.Name -eq "drivers"})
                
                # If found, add driver path to the PATH environment varaible
                if ($null -ne $driverPath)
                {
                	$env:PATH += "$([IO.Path]::PathSeparator)$($driverPath.FullName)"
                }
                
                # Adjust call to flyway command based on OS
                if ($IsLinux)
                {
                    & bash $flywayCmd $arguments
                }
                else
                {
                    & $flywayCmd $arguments
                }
                
                # Check exit code
                if ($lastExitCode -ne 0)
                {
                	# Fail the step
                    Write-Error "Execution of Flyway failed!"
                }
                
                $currentDate = Get-Date
                $currentDateFormatted = $currentDate.ToString("yyyyMMdd_HHmmss")
                
                # Check to see if the dry run variable has a value
                if (![string]::IsNullOrWhitespace($dryRunOutputFile))
                {     
                    $sqlDryRunFile = "$($dryRunOutputFile).sql"
                    $htmlDryRunFile = "$($dryRunOutputFile).html"
                    
                    if (Test-Path $sqlDryRunFile)
                    {
                    	New-OctopusArtifact -Path $sqlDryRunFile -Name "$($flywayStepName)_$($flywayEnvironment)_$($currentDateFormatted)_dryRunOutput.sql"
                    }
                    
                    if (Test-Path $htmlDryRunFile)
                    {
                    	New-OctopusArtifact -Path $htmlDryRunFile -Name "$($flywayStepName)_$($flywayEnvironment)_$($currentDateFormatted)_dryRunOutput.html"
                    }
                }
                
                $reportFile = Join-Path $(Get-Location) "report.html"
                    
                if (Test-Path $reportFile)
                {
                  	New-OctopusArtifact -Path $reportFile -Name "$($flywayStepName)_$($flywayEnvironment)_$($currentDateFormatted)_report.html"
                }
                EOT
            Octopus.Action.Script.ScriptSource = "Inline"
            Octopus.Action.Script.Syntax = "PowerShell"
        }
        worker_pool_variable = "#{ProcessTemplate.WorkerPool}"

        community_action_template_snapshot {
            id = "CommunityActionTemplates-1521"
            version = 15

            parameter "Flyway.Package.Value" {
                display_settings = {
                    Octopus.ControlType = "Package"
                }
                help_text = <<-EOT
                        **Required**
                        
                        The package containing the migration scripts you want Flyway to run.  Please refer to [documentation](https://flywaydb.org/documentation/concepts/migrations) for core concepts and naming conventions.
                        EOT
                label = "Flyway Package"
                default_value = ""
            }

            parameter "Flyway.Executable.Path" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The path of the flyway executable.  It can either be a relative path or an absolute path.
                        
                        When not provided, this step template will test for the following.  The step template places precedence on the version of the flyway included in the package. If Flyway is NOT found in the package, it will attempt to see if it is installed on the server by checking common paths.
                        
                        Running on `Linux`:
                        - `.flyway`: the package being deployed includes flyway and is running on Linux
                        - `/flyway/flyway`: The default path for the Linux execution container.
                        
                        Running on Windows:
                        - `\.flyway.cmd`: the package being deployed includes flyway and is running on Windows
                        - `flyway`: the package is in the path on the Windows VM or Windows Execution container.
                        EOT
                label = "Flyway Executable Path"
                default_value = ""
            }

            parameter "Flyway.Command.Value" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        migrate|Migrate
                        migrate dry run|Migrate Dry Run
                        check changes|Check Changes
                        check drift|Check Drift
                        check dry run|Check Dry Run
                        info|Info
                        validate|Validate
                        undo|Undo
                        repair|Repair
                        clean|Clean
                        baseline|Baseline
                        snapshot|Snapshot
                        EOT
                }
                help_text = <<-EOT
                        **Required**
                        
                        The [flyway command](https://flywaydb.org/documentation/usage/commandline/) you wish to run.
                        
                        - `Migrate`: Migrates the schema to the latest version
                        - `Migrate Dry Run`: Does a migration dry run and saves the results to a file that is uploaded as an artifact.  This works for the `Teams` version of Flyway only.
                        - `Check Changes`: Produces a report indicating differences between applied migration scripts on your target database and pending migrations scripts (ie. the set of instructions you want to use to change your target database).  This will report on the differences and perform a dry-run migration.  Check Redgate's documentation to ensure your server technology is supported.  Available to `Enterprise` licenses only.
                        - `Check Drift`: Produces a report indicating differences between the structure of your target database and the structure created by the migrations applied by Flyway. Available to `Enterprise` licenses only.
                        - `Check Dry Run`: Produces a report listing out the migration scripts to run.  Use this to perform a dry run check or if you have a `Teams` license.
                        - `Info`: Prints the details and status information about all migrations.  
                        - `Validate`: Validates applied migrations against resolved ones (on the filesystem or classpath) to detect accidental changes that may prevent the schema(s) from being recreated precisely.
                        - `Undo`: Undoes the most recently applied versioned migration.  You must provide a Flyway `Teams` or `Enterprise` license key for this to work.
                        - `Repair`: Repairs the Flyway schema history table by removing any failed migrations and realigning the checksums, descriptions and types of the applied migrations with the ones of the available migrations
                        - `Clean`: It will effectively give you a fresh start, by wiping your configured schemas completely clean. All objects (tables, views, procedures, ) will be dropped.  **DO NOT USE AGAINST A PRODUCTION DB!!!**
                        - `Baseline`:  Introducing Flyway to existing databases by baselining them at a specific version. This will cause Migrate to ignore all migrations up to and including the baseline version. Newer migrations will then be applied as usual.
                        - `Snapshot`: Creates a file containing the schema of the specified database for subsequent use with the `Check Drift` option.  Available to `Enterprise` licenses only.
                        
                        EOT
                label = "Flyway Command"
                default_value = "migrate"
            }

            parameter "Flyway.License.Key" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The [Flyway Teams](https://flywaydb.org/download) or `Enterprise` license key will enable undo functionality and the ability to dry run a migration.
                        EOT
                label = "License Key (deprecated)"
                default_value = ""
            }

            parameter "Flyway.Email.Address" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "The email address associated with the Personal Access Token (PAT)."
                label = "Email address"
                default_value = ""
            }

            parameter "Flyway.PersonalAccessToken" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = <<-EOT
                        The Personal Access Token (PAT) to authenticate with for Enterprise features.  
                        
                        Replaces the License Key.
                        EOT
                label = "Personal Access Token (PAT)"
                default_value = ""
            }

            parameter "Flyway.Target.Url" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required**
                        
                        The [URL](https://flywaydb.org/documentation/configuration/parameters/url) parameter used in Flyway.  This is the URL of the database to run the migration scripts on in the format specified in the default flyway.conf file.
                        
                        Examples:
                        - SQL Server: `jdbc:sqlserver://host:port;databaseName=database`
                        - Oracle: `jdbc:oracle:thin:@//host:port/service` or `jdbc:oracle:thin:@tns_entry`
                        - MySQL: `jdbc:mysql://host:port/database`
                        - PostgreSQL: `jdbc:postgresql://host:port/database`
                        - SQLite: `jdbc:sqlite:database`
                        
                        Please refer to [documentation](https://flywaydb.org/documentation/database/sqlserver) for further examples.
                        EOT
                label = "-Url"
                default_value = ""
            }

            parameter "Flyway.Authentication.Method" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        awsiam|AWS EC2 IAM Role
                        azuremanagedidentity|Azure Managed Identity
                        gcpserviceaccount|GCP Service Account
                        usernamepassword|Username\Password
                        windowsauthentication|Windows Authentication
                        EOT
                }
                help_text = "Method used to authenticate to the database server."
                label = "Authentication Method"
                default_value = "usernamepassword"
            }

            parameter "Flyway.Database.User" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The [user](https://flywaydb.org/documentation/configuration/parameters/user) used to connect to the database.
                        EOT
                label = "-User"
                default_value = ""
            }

            parameter "Flyway.Database.User.Password" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The [password](https://flywaydb.org/documentation/configuration/parameters/password) used to connect to the database.
                        EOT
                label = "-Password"
                default_value = ""
            }

            parameter "Flyway.Command.Schemas" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        Comma-separated case-sensitive list of [schemas](https://flywaydb.org/documentation/configuration/parameters/schemas) managed by Flyway. 
                        
                        Example: `schema1,schema2`
                        
                        Flyway will attempt to create these schemas if they do not already exist and will clean them in the order of this list. If Flyway created them, then the schemas themselves will be dropped when cleaning.
                        
                        The first schema in the list will act as the default schema.
                        EOT
                label = "-Schemas"
                default_value = ""
            }

            parameter "Flyway.Command.Target" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** for `migrate`, `info`, `validate`, `check`, and `undo`.  **Ignored** for all other commands
                        
                        The [target version](https://flywaydb.org/documentation/configuration/parameters/target) up to which Flyway should consider migrations. If set to a value other than current or latest, this must be a valid migration version (e.g. `2.1`).
                        
                        When migrating forwards, Flyway will apply all migrations up to and including the target version. Migrations with a higher version number will be ignored. If the target is `current`, then no versioned migrations will be applied but repeatable migrations will be, together with any callbacks.
                        
                        When undoing migrations, Flyway will apply all undo scripts up to and including the target version. Undo scripts with a lower version number will be ignored. Specifying a target version should be done with care, as undo scripts typically destroy database objects.
                        
                        Special Values:
                        - `current`: designates the current version of the schema
                        - `latest`: the latest version of the schema, as defined by the migration with the highest version
                        
                        Default is: `latest`.  When running the `undo` command, this will switch to `current` if `latest` is supplied.
                        EOT
                label = "-Target"
                default_value = "latest"
            }

            parameter "Flyway.Command.CherryPick" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** for `migrate`, `info`, `check`, and `validate`.  **Ignored** for all other commands.
                        
                        A Comma separated list of migrations that Flyway should consider when migrating, undoing, or repairing. Migrations are considered in the order that they are supplied, overriding the default ordering. Leave blank to consider all discovered migrations.
                        
                        Each item in the list must either be a valid migration version (e.g `2.1`) or a valid migration description (e.g. `create_table`).
                        
                        See [documentation](https://flywaydb.org/documentation/configuration/parameters/cherryPick) for more details.
                        
                        The default is an empty string, meaning this command-line argument will be skipped.
                        EOT
                label = "-CherryPick"
                default_value = ""
            }

            parameter "Flyway.Command.OutOfOrder" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        true|True
                        false|False
                        EOT
                }
                help_text = <<-EOT
                        **Optional** for `migrate`, `info`, `check`, and `validate`.  **Ignored** for all other commands.
                        
                        Allows migrations to be run out of order.
                        
                        If you already have versions `1.0` and `3.0` applied, and now a version `2.0` is found, it will be applied too instead of being ignored.
                        
                        See [documentation](https://flywaydb.org/documentation/configuration/parameters/outOfOrder) for more details.
                        
                        The default is `False`.
                        EOT
                label = "-OutOfOrder"
                default_value = "false"
            }

            parameter "Flyway.Command.SkipExecutingMigrations" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        true|True
                        false|False
                        EOT
                }
                help_text = <<-EOT
                        **Optional** for `migrate`.  **Ignored** for all other commands.
                        
                        Whether Flyway should skip migration execution. The remainder of the operation will run as normal - including updating the schema history table, callbacks, and so on.
                        
                        `skipExecutingMigrations` essentially allows you to mimic a migration being executed, because the schema history table is still updated as normal.
                        
                        `skipExecutingMigrations` can be used to bring an out-of-process change into Flyways change control process. For instance, a script run against the database outside of Flyway (like a hotfix) can be turned into a migration. The hotfix migration can be deployed with Flyway with `skipExecutingMigrations=true`. The schema history table will be updated with the new migration, but the script itself wont be executed again.
                        
                        `skipExecutingMigrations` can be used with cherryPick to skip specific migrations.
                        
                        See [documentation](https://flywaydb.org/documentation/configuration/parameters/skipExecutingMigrations) for more details.
                        
                        The default value is `False`.
                        EOT
                label = "-SkipExecutingMigrations"
                default_value = "false"
            }

            parameter "Flyway.Command.PlaceHolders" {
                display_settings = {
                    Octopus.ControlType = "MultiLineText"
                }
                help_text = <<-EOT
                        **Optional** for `migrate`, `info`, `validate`, `undo`, `check`, and `repair`.  **Ignored** for all other commands.
                        
                        [Placeholders](https://flywaydb.org/documentation/configuration/placeholder) to replace in SQL migrations.
                        
                        Each new line represents a new placeholder.  This will only work with string variable types, text and sensitive values.    
                        
                        Imagine this SQL Script
                        
                        ```
                        INSERT INTO ${Key1} (name) VALUES ('Mr. T')
                        GRANT SELECT ON SCHEMA ${flyway:defaultSchema} TO ${Key2}
                        ```
                        
                        Use the format **Name::Value**  for example:
                        
                        ```
                        Key1::My Super Awesome Value
                        
                        Key2::Other Super Awesome Value
                        ```
                        
                        This will replace `${Key1}` with `My Super Awesome Value` and `${Key2}` with `Other Super Awesome Value`.
                        
                        EOT
                label = "-PlaceHolders"
                default_value = ""
            }

            parameter "Flyway.Command.InfoSinceDate" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** with the `info` command and [Flyway Teams](https://flywaydb.org/documentation/usage/commandline/info#filtering-output) and Flyway Enterprise editions.  **Ignored** for all other commands.
                        
                        Limits info to show only migrations applied after this date, and any unapplied migrations. Must be in the format `dd/MM/yyyy HH:mm` (e.g. `01/12/2020 13:00`)
                        EOT
                label = "-InfoSinceDate"
                default_value = ""
            }

            parameter "Flyway.Command.InfoSinceVersion" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** with the `info` command and [Flyway Teams](https://flywaydb.org/documentation/usage/commandline/info#filtering-output) and Flyway Enterprise editions.  **Ignored** for all other commands.
                        
                        Limits info to show only migrations greater than or equal to this version, and any repeatable migrations. (e.g `1.1`)
                        EOT
                label = "-InfoSinceVersion"
                default_value = ""
            }

            parameter "Flyway.Command.BaseLineOnMigrate" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        true|True
                        false|False
                        EOT
                }
                help_text = <<-EOT
                        **Optional** when using `migrate`.  **Ignored** for all other commands.
                        
                        Whether to automatically call baseline when migrate is executed against a non-empty schema with no metadata table. This schema will then be baselined with the baselineVersion before executing the migrations. Only migrations above baselineVersion will then be applied.
                        
                        This is useful for initial Flyway production deployments on projects with an existing DB.
                        
                        Be careful when enabling this as it removes the safety net that ensures Flyway does not migrate the wrong database in case of a configuration mistake!
                        EOT
                label = "-baselineOnMigrate"
                default_value = "false"
            }

            parameter "Flyway.Command.BaselineVersion" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required** when using `Baseline` or when `BaselineOnMigrate` is set to `True`.  **Ignored** for all other commands.
                        
                        The version to tag an existing schema with when executing [baseline](https://flywaydb.org/documentation/command/baseline).
                        EOT
                label = "-baselineVersion"
                default_value = ""
            }

            parameter "Flyway.Command.BaselineDescription" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required** when using `Baseline`.  **Ignored** for all other commands.
                        
                        The Description to tag an existing schema with when executing [baseline](https://flywaydb.org/documentation/command/baseline).
                        EOT
                label = "-baseLineDescription"
                default_value = ""
            }

            parameter "Flyway.Command.Locations" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** with the `info`,  `migrate`, `repair`, `undo`, `check`, and `validate` commands. 
                        
                        Specifies the location of the script files to execute.  If left blank, the `Extracted Path` of the package will be used.
                        
                        Example: filesystem:`#{Octopus.Action.Package[Flyway.Package.Value].ExtractedPath}/MySubFolder`
                        EOT
                label = "-Locations"
                default_value = ""
            }

            parameter "Flyway.Command.CheckBuildUrl" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required** when using `Check Changes` or `Check Drift` commands and `-snapshot.FileName` is empty.  
                        
                        **Please Note:** When `-snapshot.FileName` is not empty, this parameter is ignored.
                        
                        Flyway uses the URL to an existing database as a temporary database to perform the check logic against.  Flyway will clean this database, so if you specify a full database, you must ensure it is okay for Flyway to erase its schema.
                        
                        Examples:
                        - SQL Server: `jdbc:sqlserver://host:port;databaseName=database`
                        - Oracle: `jdbc:oracle:thin:@//host:port/service` or `jdbc:oracle:thin:@tns_entry`
                        - MySQL: `jdbc:mysql://host:port/database`
                        - PostgreSQL: `jdbc:postgresql://host:port/database`
                        - SQLite: `jdbc:sqlite:database`
                        
                        Please refer to [documentation](https://flywaydb.org/documentation/database/sqlserver) for further examples.
                        EOT
                label = "-check.BuildUrl"
                default_value = ""
            }

            parameter "Flyway.Database.Check.User" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The username of the user for the build database.  Use this if the build database needs a separate username and password from the authentication information supplied above.
                        
                        **Please Note:** When `-snapshot.FileName` is not empty, this parameter is ignored.
                        EOT
                label = "-check.BuildUser"
                default_value = ""
            }

            parameter "Flyway.Database.Check.User.Password" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The password of the user for the build database.  Use this if the build database needs a separate username and password from the authentication information supplied above.
                        
                        **Please Note:** When `-snapshot.FileName` is not empty, this parameter is ignored.
                        EOT
                label = "-check.BuildPassword"
                default_value = ""
            }

            parameter "Flyway.Command.FailOnDrift" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        true|True
                        false|False
                        EOT
                }
                help_text = <<-EOT
                        **Required** when using `Check Drift`.  Ignored for all other commands.
                        
                        Indicates if Flyway will terminate with a non-zero return code if drift is detected.  When using `Check Drift` with a snapshot and you want to see the changes, set this to `false`
                        EOT
                label = "-check.failOnDrift"
                default_value = "true"
            }

            parameter "Flyway.Command.Snapshot.FileName" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required** when using `Snapshot`.  **Optional** when using the `Check Drift` command.  **Ignored** for all other commands.
                        
                        The name, including the path, of the snapshot file to create or use.  
                        
                        If this parameter is populated the `-check.BuildUser`, `check.BuildPassword`, and `-check.BuildUrl` parameters are all ignored.
                        
                        **Hint:** If executing this step in an execution container, consider `../../../` as the path prefix as the script will execute in `/etc/octopus/default/Work/[Random Folder Name]/Flyway.Package.Value`.  `/etc/octopus/default` is mounted as a volume.  Or leverage a NAS or other file share.
                        
                        **Important:** You will need this file for future steps. It must be stored in a non-temporary location.  By default, Octopus runs this script in a temporary location on a worker.  That location is deleted automatically once this step is complete.  If you do not supply a path, the file will be deleted.
                        EOT
                label = "-snapshot.FileName"
                default_value = ""
            }

            parameter "Flyway.Additional.Arguments" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Any additional arguments that need to be passed (ie `-table=\"MyTable\")"
                label = "Additional arguments"
                default_value = ""
            }
        }

        packages "Flyway.Package.Value" {
            acquisition_location = "Server"
            feed = "octopus-server-built-in"
            package_id = ""
            properties = {
                Extract = "True"
                PackageParameterName = "Flyway.Package.Value"
                SelectionMode = "deferred"
            }
        }
    }
}

step "manual-intervention-required" {
    name = "Manual Intervention Required"

    action {
        action_type = "Octopus.Manual"
        excluded_environments_variable = "#{Production Environment}"
        is_required = true
        properties = {
            Octopus.Action.Manual.BlockConcurrentDeployments = "False"
            Octopus.Action.Manual.Instructions = "Please review and deploy."
            Octopus.Action.Manual.ResponsibleTeamIds = "#{ProcessTemplate.Approval.Team}"
        }
    }
}

step "flyway-database-migrations" {
    name = "Flyway Database Migrations"

    action {
        action_type = "Octopus.Script"
        properties = {
            Flyway.Authentication.Method = "usernamepassword"
            Flyway.Command.BaseLineOnMigrate = "false"
            Flyway.Command.FailOnDrift = "true"
            Flyway.Command.OutOfOrder = "false"
            Flyway.Command.SkipExecutingMigrations = "false"
            Flyway.Command.Target = "latest"
            Flyway.Command.Value = "migrate"
            Flyway.Package.Value = "ProcessTemplate.Flyway.Package"
            Octopus.Action.EnabledFeatures = "Octopus.Features.SelectPowerShellEditionForWindows"
            Octopus.Action.PowerShell.Edition = "Core"
            Octopus.Action.RunOnServer = "true"
            Octopus.Action.Script.ScriptBody = <<-EOT
                $VerboseActionPreference="Continue"
                
                function Get-FlywayExecutablePath
                {
                	param (
                    	$providedPath
                    )
                    
                    if ([string]::IsNullOrWhiteSpace($providedPath) -eq $false)
                    {
                    	Write-Host "The executable path was provided, testing to see if it is absolute or relative"
                		if ([IO.Path]::IsPathRooted($providedPath))
                        {
                        	Write-Host "The provided path is absolute, using that"
                            
                        	return $providedPath
                        }
                        
                        Write-Host "The provided path was relative, combining $(Get-Location) with $providedPath"
                        return Join-Path $(Get-Location) $providedPath
                    }
                    
                    Write-Host "Checking to see if we are currently running on Linux"
                    if ($IsLinux)    
                    {
                    	Write-Host "Currently running on Linux"
                    	Write-Host "Checking to see if flyway was included with the package"
                    	if (Test-Path "./flyway")
                        {
                        	Write-Host "It was, using that version of flyway"
                        	return "flyway"
                        }
                        
                        Write-Host "Testing to see if we are on an execution container with /flyway/flyway as the path"
                    	if (Test-Path "/flyway/flyway")
                        {
                        	Write-Host "We are, using /flyway/flyway"
                        	return "/flyway/flyway"
                        }               
                    }
                    
                    Write-Host "Currently running on Windows"
                    
                    Write-Host "Testing to see if flyway.cmd was included with the package"
                    if (Test-Path ".\flyway.cmd")
                    {
                    	Write-Host "It was, using that version."
                    	return ".\flyway.cmd"
                    }
                    
                    Write-Host "Testing to see if flyway can be found in the env path"
                    $flywayExecutable = (Get-Command "flyway" -ErrorAction SilentlyContinue)
                    if ($null -ne $flywayExecutable)
                    {
                    	Write-Host "The flyway folder is part of the environment path"
                        return $flywayExecutable.Source
                    }
                    
                    Fail-Step "Unable to find flyway executable.  Please include it as part of the package, or provide the path to it."
                }
                
                function Test-AddParameterToCommandline
                {
                	param (
                    	$acceptedCommands,
                        $selectedCommand,
                        $parameterValue,
                        $defaultValue,
                        $parameterName
                    )
                    
                    if ([string]::IsNullOrWhiteSpace($parameterValue) -eq $true)
                    {    	
                    	Write-Verbose "$parameterName is empty, returning false"
                    	return $false
                    }
                    
                    if ([string]::IsNullOrWhiteSpace($defaultValue) -eq $false -and $parameterValue.ToLower().Trim() -eq $defaultValue.ToLower().Trim())
                    {
                    	Write-Verbose "$parameterName is matches the default value, returning false"
                    	return $false
                    }
                    
                    if ([string]::IsNullOrWhiteSpace($acceptedCommands) -eq $true -or $acceptedCommands -eq "any")
                    {
                    	Write-Verbose "$parameterName has a value and this is for any command, returning true"
                    	return $true
                    }
                    
                    $acceptedCommandArray = $acceptedCommands -split ","
                    foreach ($command in $acceptedCommandArray)
                    {
                    	if ($command.ToLower().Trim() -eq $selectedCommand.ToLower().Trim())
                        {
                        	Write-Verbose "$parameterName has a value and the current command $selectedCommand matches the accepted command $command, returning true"
                        	return $true
                        }
                    }
                    
                    Write-Verbose "$parameterName has a value but is not accepted in the current command, returning false"
                    return $false
                }
                
                function Get-ParsedUrl
                {
                	# Define parameters
                    param (
                    	$ConnectionUrl
                    )
                    
                    # Remove the 'jdbc:' portion from the $ConnectionUrl parameter
                    $ConnectionUrl = $ConnectionUrl.ToLower().Replace("jdbc:", "")
                    
                    # Parse and return the url
                    return [System.Uri]$ConnectionUrl
                }
                
                # Declaring the path to the NuGet package
                $flywayPackagePath = $OctopusParameters["Octopus.Action.Package[Flyway.Package.Value].ExtractedPath"]
                $flywayUrl = $OctopusParameters["Flyway.Target.Url"]
                $flywayUser = $OctopusParameters["Flyway.Database.User"]
                $flywayUserPassword = $OctopusParameters["Flyway.Database.User.Password"]
                $flywayCommand = $OctopusParameters["Flyway.Command.Value"]
                $flywayLicenseKey = $OctopusParameters["Flyway.License.Key"]
                $flywayLicenseEmail = $OctopusParameters["Flyway.Email.Address"]
                $flywayLicensePAT = $OctopusParameters["Flyway.PersonalAccessToken"]
                $flywayExecutablePath = $OctopusParameters["Flyway.Executable.Path"]
                $flywaySchemas = $OctopusParameters["Flyway.Command.Schemas"]
                $flywayTarget = $OctopusParameters["Flyway.Command.Target"]
                $flywayInfoSinceDate = $OctopusParameters["Flyway.Command.InfoSinceDate"]
                $flywayInfoSinceVersion = $OctopusParameters["Flyway.Command.InfoSinceVersion"]
                $flywayLicensedEdition = $OctopusParameters["Flyway.License.Version"]
                $flywayCherryPick = $OctopusParameters["Flyway.Command.CherryPick"]
                $flywayOutOfOrder = $OctopusParameters["Flyway.Command.OutOfOrder"]
                $flywaySkipExecutingMigrations = $OctopusParameters["Flyway.Command.SkipExecutingMigrations"]
                $flywayPlaceHolders = $OctopusParameters["Flyway.Command.PlaceHolders"]
                $flywayBaseLineVersion = $OctopusParameters["Flyway.Command.BaselineVersion"]
                $flywayBaselineDescription = $OctopusParameters["Flyway.Command.BaselineDescription"]
                $flywayAuthenticationMethod = $OctopusParameters["Flyway.Authentication.Method"]
                $flywayLocations = $OctopusParameters["Flyway.Command.Locations"]
                $flywayAdditionalArguments = $OctopusParameters["Flyway.Additional.Arguments"]
                $flywayStepName = $OctopusParameters["Octopus.Action.StepName"]
                $flywayEnvironment = $OctopusParameters["Octopus.Environment.Name"]
                $flywayCheckBuildUrl = $OctopusParameters["Flyway.Command.CheckBuildUrl"]
                $flywayCheckBuildUsername = $OctopusParameters["Flyway.Database.Check.User"]
                $flywayCheckBuildPassword = $OctopusParameters["Flyway.Database.Check.User.Password"]
                $flywayBaselineOnMigrate = $OctopusParameters["Flyway.Command.BaseLineOnMigrate"]
                $flywaySnapshotFileName = $OctopusParameters["Flyway.Command.Snapshot.FileName"]
                $flywayCheckFailOnDrift = $OctopusParameters["Flyway.Command.FailOnDrift"]
                
                if ([string]::IsNullOrWhitespace($flywayLocations))
                {
                	$flywayLocations = "filesystem:$flywayPackagePath"
                }
                
                
                # Logging for troubleshooting
                Write-Host "*******************************************"
                Write-Host "Logging variables:"
                Write-Host " - - - - - - - - - - - - - - - - - - - - -"
                Write-Host "PackagePath: $flywayPackagePath"
                Write-Host "Flyway Executable Path: $flywayExecutablePath"
                Write-Host "Flyway Command: $flywayCommand"
                Write-Host "-url: $flywayUrl"
                Write-Host "-user: $flywayUser"
                Write-Host "-schemas: $flywaySchemas"
                Write-Host "-target: $flywayTarget"
                Write-Host "-cherryPick: $flywayCherryPick"
                Write-Host "-outOfOrder: $flywayOutOfOrder"
                Write-Host "-skipExecutingMigrations: $flywaySkipExecutingMigrations"
                Write-Host "-infoSinceDate: $flywayInfoSinceDate"
                Write-Host "-infoSinceVersion: $flywayInfoSinceVersion"
                Write-Host "-baselineOnMigrate: $flywayBaselineOnMigrate"
                Write-Host "-baselineVersion: $flywayBaselineVersion"
                Write-Host "-baselineDescription: $flywayBaselineDescription"
                Write-Host "-locations: $flywayLocations"
                Write-Host "-check.BuildUrl: $flywayCheckBuildUrl"
                Write-Host "-check.failOnDrift: $flywayCheckFailOnDrift"
                Write-Host "-snapshot.FileName OR check.DeployedSnapshot: $flywaySnapshotFileName"
                Write-Host "Additional Arguments: $flywayAdditionalArguments"
                Write-Host "placeHolders: $flywayPlaceHolders"
                Write-Host "*******************************************"
                
                if ($null -eq $IsWindows) {
                    Write-Host "Determining Operating System..."
                    $IsWindows = ([System.Environment]::OSVersion.Platform -eq "Win32NT")
                    $IsLinux = ([System.Environment]::OSVersion.Platform -eq "Unix")
                }
                
                Write-Host "Setting execution location to: $flywayPackagePath"
                Set-Location $flywayPackagePath
                
                $flywayCmd = Get-FlywayExecutablePath -providedPath $flywayExecutablePath
                
                $commandToUse = $flywayCommand
                if ($flywayCommand -eq "migrate dry run")
                {
                	$commandToUse = "migrate"
                }
                
                if ($flywayCommand -eq "check dry run" -or $flywayCommand -eq "check changes" -or $flywayCommand -eq "check drift")
                {
                	$commandToUse = "check"
                }
                
                $arguments = @(
                	$commandToUse    
                )
                
                if ($flywayCommand -eq "check dry run")
                {
                	$arguments += "-dryrun"
                }
                
                if ($flywayCommand -eq "check changes")
                {
                	$arguments += "-changes"
                    $arguments += "-dryrun"
                }
                
                if ($flywayCommand -eq "check drift")
                {
                	$arguments += "-drift"
                }
                
                # Deteremine authentication method
                switch ($flywayAuthenticationMethod)
                {
                	"awsiam"
                    {
                		# Check to see if OS is Windows and running in a container
                        if ($IsWindows -and $env:DOTNET_RUNNING_IN_CONTAINER)
                        {
                        	throw "IAM Role authentication is not supported in a Windows container."
                        }
                
                		# Get parsed connection string url
                        $parsedUrl = Get-ParsedUrl -ConnectionUrl $flywayUrl
                        
                        # Region is part of the RDS endpoint, extract
                        $region = ($parsedUrl.Host.Split("."))[2]
                
                		Write-Host "Generating AWS IAM token ..."
                		$flywayUserPassword = (aws rds generate-db-auth-token --hostname $parsedUrl.Host --region $region --port $parsedUrl.Port --username $flywayUser)
                
                		$arguments += "-user=`"$flywayUser`""
                    	$arguments += "-password=`"$flywayUserPassword`""
                
                		break
                    }
                	"azuremanagedidentity"
                    {
                		# Check to see if OS is Windows and running in a container
                        if ($IsWindows -and $env:DOTNET_RUNNING_IN_CONTAINER)
                        {
                        	throw "Azure Managed Identity is not supported in a Windows container."
                        }
                        
                        # SQL Server driver doesn't assign password
                        if (!$flywayUrl.ToLower().Contains("jdbc:sqlserver:"))
                        {        
                          # Get login token
                          Write-Host "Generating Azure Managed Identity token ..."
                          $token = Invoke-RestMethod -Method GET -Uri "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://ossrdbms-aad.database.windows.net" -Headers @{"MetaData" = "true"} -UseBasicParsing
                
                          $flywayUserPassword = $token.access_token
                          $arguments += "-password=`"$flywayUserPassword`""
                          $arguments += "-user=`"$flywayUser`""
                        }
                        else
                        {
                            
                			# Check to see if the querstring parameter for Azure Managed Identity is present
                            if (!$flywayUrl.ToLower().Contains("authentication=activedirectorymsi"))
                            {
                                # Add the authentication piece to the jdbc url
                                if (!$flywayUrl.EndsWith(";"))
                                {
                                	# Add the separator
                                    $flywayUrl += ";"
                                }
                                
                                # Add authentication piece
                                $flywayUrl += "Authentication=ActiveDirectoryMSI"
                            }
                        }
                        
                        break
                    }
                    "gcpserviceaccount"
                    {
                		# Check to see if OS is Windows and running in a container
                        if ($IsWindows -and $env:DOTNET_RUNNING_IN_CONTAINER)
                        {
                        	throw "GCP Service Account authentication is not supported in a Windows container."
                        }
                    
                        # Define header
                        $header = @{ "Metadata-Flavor" = "Google"}
                
                        # Retrieve service accounts
                        $serviceAccounts = Invoke-RestMethod -Method Get -Uri "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/" -Headers $header -UseBasicParsing
                
                        # Results returned in plain text format, get into array and remove empty entries
                        $serviceAccounts = $serviceAccounts.Split([Environment]::NewLine, [StringSplitOptions]::RemoveEmptyEntries)
                
                        # Retreive the specific service account assigned to the VM
                        $serviceAccount = $serviceAccounts | Where-Object {$_.ToLower().Contains("iam.gserviceaccount.com") }
                
                		Write-Host "Generating GCP IAM token ..."
                        # Retrieve token for account
                        $token = Invoke-RestMethod -Method Get -Uri "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/$serviceAccount/token" -Headers $header -UseBasicParsing
                        
                        $flywayUserPassword = $token.access_token
                        
                        $arguments += "-user=`"$flywayUser`""
                        $arguments += "-password=`"$flywayUserPassword`""
                        #$env:FLYWAY_PASSWORD = $flywayUserPassword
                        
                        break
                    }   
                    "usernamepassword"
                    {
                    	# Add password
                        Write-Host "Testing for parameters that can be applied to any command"
                        if (Test-AddParameterToCommandline -parameterValue $flywayUser -acceptedCommands "any" -selectedCommand $flywayCommand -parameterName "-user")
                        {
                            Write-Host "User provided, adding user and password command line argument"
                            $arguments += "-user=`"$flywayUser`""
                            $arguments += "-password=`"$flywayUserPassword`""
                        }
                        
                        break
                    }
                    "windowsauthentication"
                    {
                    	# Display to the user they've selected windows authentication.  Though this is dictated by the jdbc url, this is added to make sure the user knows that's what is
                        # being used
                        Write-Host "Using Windows Authentication"
                        
                        # Check for integratedauthentication=true in url
                        if (!$flywayUrl.ToLower().Contains("integratedsecurity=true"))
                        {
                        	# Check to see if the connection url ends with a ;
                            if (!$flywayUrl.EndsWith(";"))
                            {
                            	# Add the ;
                                $flywayUrl += ";"
                            }
                            
                            $flywayUrl += "integratedSecurity=true;"
                        }
                        break
                    }
                }
                
                $arguments += "-url=`"$flywayUrl`""
                $arguments += "-locations=`"$flywayLocations`""
                
                if (Test-AddParameterToCommandline -parameterValue $flywaySchemas -acceptedCommands "any" -selectedCommand $flywayCommand -parameterName "-schemas")
                {
                	Write-Host "Schemas provided, adding schemas command line argument"
                	$arguments += "-schemas=`"$flywaySchemas`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayLicenseKey -acceptedCommands "any" -selectedCommand $flywayCommand -parameterName "-licenseKey")
                {
                	Write-Host "License key provided, adding -licenseKey command line argument"
                    Write-Host "*****WARNING***** Use of the License Key has been deprecated by Redgate and will be removed in future versions, use the Personal Access Token method instead."
                	$arguments += "-licenseKey=`"$flywayLicenseKey`""                  
                }
                
                if (![string]::IsNullOrWhiteSpace($flywayLicenseEmail) -and ![string]::IsNullOrWhiteSpace($flywayLicensePAT))
                {
                    if (Test-AddParameterToCommandline -parameterValue $flywayLicensePAT -acceptedCommands "any" -selectedCommand $flywayCommand -parameterName "-token")
                    {
                        Write-Host "Personal Access Token provided, adding -email and -token command line arguments"
                        $arguments += @("-email=`"$flywayLicenseEmail`"", "-token=`"$flywayLicensePAT`"")
                    }
                }
                
                Write-Host "Finished testing for parameters that can be applied to any command, moving onto command specific parameters"
                
                if (Test-AddParameterToCommandline -parameterValue $flywayCherryPick -acceptedCommands "migrate,info,validate,check" -selectedCommand $flywayCommand -parameterName "-cherryPick")
                {
                	Write-Host "Cherry pick provided, adding cherry pick command line argument"
                	$arguments += "-cherryPick=`"$flywayCherryPick`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayOutOfOrder -defaultValue "false" -acceptedCommands "migrate,info,validate,check" -selectedCommand $commandToUse -parameterName "-outOfOrder")
                {
                	Write-Host "Out of order is not false, adding out of order command line argument"
                	$arguments += "-outOfOrder=`"$flywayOutOfOrder`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayPlaceHolders -acceptedCommands "migrate,info,validate,undo,repair,check" -selectedCommand $commandToUse -parameterName "-placeHolders")
                {
                	Write-Host "Placeholder parameter provided, adding them to the command line arguments"
                    
                    $placeHolderValueList = @(($flywayPlaceHolders -Split "`n").Trim())
                    foreach ($placeHolder in $placeHolderValueList)
                    {
                    	$placeHolderSplit = $placeHolder -Split "::"
                        $placeHolderKey = $placeHolderSplit[0]
                        $placeHolderValue = $placeHolderSplit[1]
                        Write-Host "Adding -placeHolders.$placeHolderKey = $placeHolderValue to the argument list"
                        
                        $arguments += "-placeholders.$placeHolderKey=`"$placeHolderValue`""    
                    }   	
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayTarget -acceptedCommands "migrate,info,validate,undo,check" -selectedCommand $commandToUse -parameterName "-target")
                {
                	Write-Host "Target provided, adding target command line argument"
                
                	if ($flywayTarget.ToLower().Trim() -eq "latest" -and $flywayCommand -eq "undo")
                	{
                		Write-Host "The current target is latest, but the command is undo, changing the target to be current"
                		$flywayTarget = "current"
                	}
                
                	$arguments += "-target=`"$flywayTarget`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywaySkipExecutingMigrations -defaultValue "false" -acceptedCommands "migrate" -selectedCommand $flywayCommand -parameterName "-skipExecutingMigrations")
                {
                	Write-Host "Skip executing migrations is not false, adding skip executing migrations command line argument"
                	$arguments += "-skipExecutingMigrations=`"$flywaySkipExecutingMigrations`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayBaselineOnMigrate -defaultValue "false" -acceptedCommands "migrate" -selectedCommand $flywayCommand -parameterName "-baselineOnMigrate")
                {
                	Write-Host "Baseline on migrate is not false, adding the baseline on migrate argument"
                	$arguments += "-baselineOnMigrate=`"$flywayBaselineOnMigrate`""    
                    
                    if (Test-AddParameterToCommandline -parameterValue $flywayBaselineVersion -acceptedCommands "migrate" -selectedCommand $flywayCommand -parameterName "-baselineVersion")
                    {
                    	Write-Host "Baseline version has been specified, adding baseline version argument"
                		$arguments += "-baselineVersion=`"$flywayBaselineVersion`""  
                    }
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayBaselineVersion -acceptedCommands "baseline" -selectedCommand $flywayCommand -parameterName "-baselineVersion")
                {
                	Write-Host "Doing a baseline, adding baseline version and description"
                	$arguments += "-baselineVersion=`"$flywayBaselineVersion`""    
                    $arguments += "-baselineDescription=`"$flywayBaselineDescription`""    
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayInfoSinceDate -acceptedCommands "info" -selectedCommand $flywayCommand -parameterName "-infoSinceDate")
                {
                	Write-Host "Info since date has been provided, adding that to the command line arguments"
                	$arguments += "-infoSinceDate=`"$flywayInfoSinceDate`""
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayInfoSinceVersion -acceptedCommands "info" -selectedCommand $flywayCommand -parameterName "-infoSinceVersion")
                {
                	Write-Host "Info since version has been provided, adding that to the command line arguments"
                	$arguments += "-infoSinceVersion=`"$flywayInfoSinceVersion`""
                } 
                
                if (Test-AddParameterToCommandline -parameterValue $flywaySnapshotFileName -acceptedCommands "snapshot" -selectedCommand $commandToUse -parameterName "-snapshot.filename")
                {
                	Write-Host "Snapshot filename has been provided, adding that to the command line arguments"
                    $folderName = Split-Path -Parent $flywaySnapshotFileName
                    if ((test-path $folderName) -eq $false)
                    {
                    	New-Item $folderName -ItemType Directory
                    }
                    $arguments += "-snapshot.filename=`"$flywaySnapshotFileName`""
                }
                
                $snapshotFileNameforCheckProvided = $false
                if (Test-AddParameterToCommandline -parameterValue $flywaySnapshotFileName -acceptedCommands "check" -selectedCommand $commandToUse -parameterName "-check.deployedSnapshot")
                {
                	Write-Host "Snapshot filename has been provided for the check command, adding that to the command line arguments"
                    $folderName = Split-Path -Parent $flywaySnapshotFileName
                    if ((test-path $folderName) -eq $false)
                    {
                    	New-Item $folderName -ItemType Directory
                    }
                    $arguments += "-check.deployedSnapshot=`"$flywaySnapshotFileName`""
                    $snapshotFileNameforCheckProvided = $true
                }
                
                if ((Test-AddParameterToCommandline -parameterValue $flywayCheckBuildUrl -acceptedCommands "check" -selectedCommand $commandToUse -parameterName "-check.buildUrl") -eq $true -and $snapshotFileNameforCheckProvided -eq $false)
                {
                	Write-Host "Check build URL has been provided, adding that to the command line arguments"
                	$arguments += "-check.buildUrl=`"$flywayCheckBuildUrl`""
                }
                
                Write-Host "Checking to see if the check username and password were supplied"
                if ((Test-AddParameterToCommandline -parameterValue $flywayCheckBuildUsername -acceptedCommands "check" -selectedCommand $commandToUse -parameterName "-user")  -eq $true -and $snapshotFileNameforCheckProvided -eq $false)
                {
                	Write-Host "Check User provided, adding check user and check password command line argument"
                	$arguments += "-check.buildUser=`"$flywayCheckBuildUsername`""
                	$arguments += "-check.buildPassword=`"$flywayCheckBuildPassword`""
                }
                
                if (Test-AddParameterToCommandline -parameterValue $flywayCheckFailOnDrift -acceptedCommands "check drift" -selectedCommand $flywayCommand -parameterName "-check.failOnDrift")
                {
                	Write-Host "Doing a check drift command, adding the fail on drift"
                	$arguments += "-check.failOnDrift=`"$flywayCheckFailOnDrift`""
                }
                
                
                Write-Host "Finished checking for command specific parameters, moving onto execution"
                $dryRunOutputFile = ""
                
                if ($flywayCommand -eq "migrate dry run")
                {
                	$dryRunOutputFile = Join-Path $(Get-Location) "dryRunOutput"
                    Write-Host "Adding the argument dryRunOutput so Flyway will perform a dry run and not an actual migration."
                    $arguments += "-dryRunOutput=`"$dryRunOutputFile`""
                }
                
                # Check to see if there's any additional arguments to add
                if (![string]::IsNullOrWhitespace($flywayAdditionalArguments))
                {
                	# Split on space
                    $flywayAdditionalArgumentsArray = ($flywayAdditionalArguments.Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries))
                
                    # Loop through array
                    foreach ($newArgument in $flywayAdditionalArgumentsArray)
                    {
                    	# Add the arguments
                    	$arguments += $newArgument
                    }
                }
                
                # Display what's going to be run
                if (![string]::IsNullOrWhitespace($flywayUserPassword))
                {
                    $flywayDisplayArguments = $arguments.PSObject.Copy()
                    $arrayIndex = 0
                    for ($i = 0; $i -lt $flywayDisplayArguments.Count; $i++)
                    {
                        if ($null -ne $flywayDisplayArguments[$i])
                        {
                            if ($flywayDisplayArguments[$i].Contains($flywayUserPassword))
                            {
                                $flywayDisplayArguments[$i] = $flywayDisplayArguments[$i].Replace($flywayUserPassword, "****")
                            }
                        }
                    }
                
                    Write-Host "Executing the following command: $flywayCmd $flywayDisplayArguments"
                }
                else
                {
                    Write-Host "Executing the following command: $flywayCmd $arguments"
                }
                
                # Attempt to find driver path for java
                $driverPath = (Get-ChildItem -Path (Get-ChildItem -Path $flywayCmd).Directory -Recurse | Where-Object {$_.PSIsContainer -eq $true -and $_.Name -eq "drivers"})
                
                # If found, add driver path to the PATH environment varaible
                if ($null -ne $driverPath)
                {
                	$env:PATH += "$([IO.Path]::PathSeparator)$($driverPath.FullName)"
                }
                
                # Adjust call to flyway command based on OS
                if ($IsLinux)
                {
                    & bash $flywayCmd $arguments
                }
                else
                {
                    & $flywayCmd $arguments
                }
                
                # Check exit code
                if ($lastExitCode -ne 0)
                {
                	# Fail the step
                    Write-Error "Execution of Flyway failed!"
                }
                
                $currentDate = Get-Date
                $currentDateFormatted = $currentDate.ToString("yyyyMMdd_HHmmss")
                
                # Check to see if the dry run variable has a value
                if (![string]::IsNullOrWhitespace($dryRunOutputFile))
                {     
                    $sqlDryRunFile = "$($dryRunOutputFile).sql"
                    $htmlDryRunFile = "$($dryRunOutputFile).html"
                    
                    if (Test-Path $sqlDryRunFile)
                    {
                    	New-OctopusArtifact -Path $sqlDryRunFile -Name "$($flywayStepName)_$($flywayEnvironment)_$($currentDateFormatted)_dryRunOutput.sql"
                    }
                    
                    if (Test-Path $htmlDryRunFile)
                    {
                    	New-OctopusArtifact -Path $htmlDryRunFile -Name "$($flywayStepName)_$($flywayEnvironment)_$($currentDateFormatted)_dryRunOutput.html"
                    }
                }
                
                $reportFile = Join-Path $(Get-Location) "report.html"
                    
                if (Test-Path $reportFile)
                {
                  	New-OctopusArtifact -Path $reportFile -Name "$($flywayStepName)_$($flywayEnvironment)_$($currentDateFormatted)_report.html"
                }
                EOT
            Octopus.Action.Script.ScriptSource = "Inline"
            Octopus.Action.Script.Syntax = "PowerShell"
        }
        worker_pool_variable = "#{ProcessTemplate.WorkerPool}"

        community_action_template_snapshot {
            id = "CommunityActionTemplates-1521"
            version = 15

            parameter "Flyway.Package.Value" {
                display_settings = {
                    Octopus.ControlType = "Package"
                }
                help_text = <<-EOT
                        **Required**
                        
                        The package containing the migration scripts you want Flyway to run.  Please refer to [documentation](https://flywaydb.org/documentation/concepts/migrations) for core concepts and naming conventions.
                        EOT
                label = "Flyway Package"
                default_value = ""
            }

            parameter "Flyway.Executable.Path" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The path of the flyway executable.  It can either be a relative path or an absolute path.
                        
                        When not provided, this step template will test for the following.  The step template places precedence on the version of the flyway included in the package. If Flyway is NOT found in the package, it will attempt to see if it is installed on the server by checking common paths.
                        
                        Running on `Linux`:
                        - `.flyway`: the package being deployed includes flyway and is running on Linux
                        - `/flyway/flyway`: The default path for the Linux execution container.
                        
                        Running on Windows:
                        - `\.flyway.cmd`: the package being deployed includes flyway and is running on Windows
                        - `flyway`: the package is in the path on the Windows VM or Windows Execution container.
                        EOT
                label = "Flyway Executable Path"
                default_value = ""
            }

            parameter "Flyway.Command.Value" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        migrate|Migrate
                        migrate dry run|Migrate Dry Run
                        check changes|Check Changes
                        check drift|Check Drift
                        check dry run|Check Dry Run
                        info|Info
                        validate|Validate
                        undo|Undo
                        repair|Repair
                        clean|Clean
                        baseline|Baseline
                        snapshot|Snapshot
                        EOT
                }
                help_text = <<-EOT
                        **Required**
                        
                        The [flyway command](https://flywaydb.org/documentation/usage/commandline/) you wish to run.
                        
                        - `Migrate`: Migrates the schema to the latest version
                        - `Migrate Dry Run`: Does a migration dry run and saves the results to a file that is uploaded as an artifact.  This works for the `Teams` version of Flyway only.
                        - `Check Changes`: Produces a report indicating differences between applied migration scripts on your target database and pending migrations scripts (ie. the set of instructions you want to use to change your target database).  This will report on the differences and perform a dry-run migration.  Check Redgate's documentation to ensure your server technology is supported.  Available to `Enterprise` licenses only.
                        - `Check Drift`: Produces a report indicating differences between the structure of your target database and the structure created by the migrations applied by Flyway. Available to `Enterprise` licenses only.
                        - `Check Dry Run`: Produces a report listing out the migration scripts to run.  Use this to perform a dry run check or if you have a `Teams` license.
                        - `Info`: Prints the details and status information about all migrations.  
                        - `Validate`: Validates applied migrations against resolved ones (on the filesystem or classpath) to detect accidental changes that may prevent the schema(s) from being recreated precisely.
                        - `Undo`: Undoes the most recently applied versioned migration.  You must provide a Flyway `Teams` or `Enterprise` license key for this to work.
                        - `Repair`: Repairs the Flyway schema history table by removing any failed migrations and realigning the checksums, descriptions and types of the applied migrations with the ones of the available migrations
                        - `Clean`: It will effectively give you a fresh start, by wiping your configured schemas completely clean. All objects (tables, views, procedures, ) will be dropped.  **DO NOT USE AGAINST A PRODUCTION DB!!!**
                        - `Baseline`:  Introducing Flyway to existing databases by baselining them at a specific version. This will cause Migrate to ignore all migrations up to and including the baseline version. Newer migrations will then be applied as usual.
                        - `Snapshot`: Creates a file containing the schema of the specified database for subsequent use with the `Check Drift` option.  Available to `Enterprise` licenses only.
                        
                        EOT
                label = "Flyway Command"
                default_value = "migrate"
            }

            parameter "Flyway.License.Key" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The [Flyway Teams](https://flywaydb.org/download) or `Enterprise` license key will enable undo functionality and the ability to dry run a migration.
                        EOT
                label = "License Key (deprecated)"
                default_value = ""
            }

            parameter "Flyway.Email.Address" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "The email address associated with the Personal Access Token (PAT)."
                label = "Email address"
                default_value = ""
            }

            parameter "Flyway.PersonalAccessToken" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = <<-EOT
                        The Personal Access Token (PAT) to authenticate with for Enterprise features.  
                        
                        Replaces the License Key.
                        EOT
                label = "Personal Access Token (PAT)"
                default_value = ""
            }

            parameter "Flyway.Target.Url" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required**
                        
                        The [URL](https://flywaydb.org/documentation/configuration/parameters/url) parameter used in Flyway.  This is the URL of the database to run the migration scripts on in the format specified in the default flyway.conf file.
                        
                        Examples:
                        - SQL Server: `jdbc:sqlserver://host:port;databaseName=database`
                        - Oracle: `jdbc:oracle:thin:@//host:port/service` or `jdbc:oracle:thin:@tns_entry`
                        - MySQL: `jdbc:mysql://host:port/database`
                        - PostgreSQL: `jdbc:postgresql://host:port/database`
                        - SQLite: `jdbc:sqlite:database`
                        
                        Please refer to [documentation](https://flywaydb.org/documentation/database/sqlserver) for further examples.
                        EOT
                label = "-Url"
                default_value = ""
            }

            parameter "Flyway.Authentication.Method" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        awsiam|AWS EC2 IAM Role
                        azuremanagedidentity|Azure Managed Identity
                        gcpserviceaccount|GCP Service Account
                        usernamepassword|Username\Password
                        windowsauthentication|Windows Authentication
                        EOT
                }
                help_text = "Method used to authenticate to the database server."
                label = "Authentication Method"
                default_value = "usernamepassword"
            }

            parameter "Flyway.Database.User" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The [user](https://flywaydb.org/documentation/configuration/parameters/user) used to connect to the database.
                        EOT
                label = "-User"
                default_value = ""
            }

            parameter "Flyway.Database.User.Password" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The [password](https://flywaydb.org/documentation/configuration/parameters/password) used to connect to the database.
                        EOT
                label = "-Password"
                default_value = ""
            }

            parameter "Flyway.Command.Schemas" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        Comma-separated case-sensitive list of [schemas](https://flywaydb.org/documentation/configuration/parameters/schemas) managed by Flyway. 
                        
                        Example: `schema1,schema2`
                        
                        Flyway will attempt to create these schemas if they do not already exist and will clean them in the order of this list. If Flyway created them, then the schemas themselves will be dropped when cleaning.
                        
                        The first schema in the list will act as the default schema.
                        EOT
                label = "-Schemas"
                default_value = ""
            }

            parameter "Flyway.Command.Target" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** for `migrate`, `info`, `validate`, `check`, and `undo`.  **Ignored** for all other commands
                        
                        The [target version](https://flywaydb.org/documentation/configuration/parameters/target) up to which Flyway should consider migrations. If set to a value other than current or latest, this must be a valid migration version (e.g. `2.1`).
                        
                        When migrating forwards, Flyway will apply all migrations up to and including the target version. Migrations with a higher version number will be ignored. If the target is `current`, then no versioned migrations will be applied but repeatable migrations will be, together with any callbacks.
                        
                        When undoing migrations, Flyway will apply all undo scripts up to and including the target version. Undo scripts with a lower version number will be ignored. Specifying a target version should be done with care, as undo scripts typically destroy database objects.
                        
                        Special Values:
                        - `current`: designates the current version of the schema
                        - `latest`: the latest version of the schema, as defined by the migration with the highest version
                        
                        Default is: `latest`.  When running the `undo` command, this will switch to `current` if `latest` is supplied.
                        EOT
                label = "-Target"
                default_value = "latest"
            }

            parameter "Flyway.Command.CherryPick" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** for `migrate`, `info`, `check`, and `validate`.  **Ignored** for all other commands.
                        
                        A Comma separated list of migrations that Flyway should consider when migrating, undoing, or repairing. Migrations are considered in the order that they are supplied, overriding the default ordering. Leave blank to consider all discovered migrations.
                        
                        Each item in the list must either be a valid migration version (e.g `2.1`) or a valid migration description (e.g. `create_table`).
                        
                        See [documentation](https://flywaydb.org/documentation/configuration/parameters/cherryPick) for more details.
                        
                        The default is an empty string, meaning this command-line argument will be skipped.
                        EOT
                label = "-CherryPick"
                default_value = ""
            }

            parameter "Flyway.Command.OutOfOrder" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        true|True
                        false|False
                        EOT
                }
                help_text = <<-EOT
                        **Optional** for `migrate`, `info`, `check`, and `validate`.  **Ignored** for all other commands.
                        
                        Allows migrations to be run out of order.
                        
                        If you already have versions `1.0` and `3.0` applied, and now a version `2.0` is found, it will be applied too instead of being ignored.
                        
                        See [documentation](https://flywaydb.org/documentation/configuration/parameters/outOfOrder) for more details.
                        
                        The default is `False`.
                        EOT
                label = "-OutOfOrder"
                default_value = "false"
            }

            parameter "Flyway.Command.SkipExecutingMigrations" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        true|True
                        false|False
                        EOT
                }
                help_text = <<-EOT
                        **Optional** for `migrate`.  **Ignored** for all other commands.
                        
                        Whether Flyway should skip migration execution. The remainder of the operation will run as normal - including updating the schema history table, callbacks, and so on.
                        
                        `skipExecutingMigrations` essentially allows you to mimic a migration being executed, because the schema history table is still updated as normal.
                        
                        `skipExecutingMigrations` can be used to bring an out-of-process change into Flyways change control process. For instance, a script run against the database outside of Flyway (like a hotfix) can be turned into a migration. The hotfix migration can be deployed with Flyway with `skipExecutingMigrations=true`. The schema history table will be updated with the new migration, but the script itself wont be executed again.
                        
                        `skipExecutingMigrations` can be used with cherryPick to skip specific migrations.
                        
                        See [documentation](https://flywaydb.org/documentation/configuration/parameters/skipExecutingMigrations) for more details.
                        
                        The default value is `False`.
                        EOT
                label = "-SkipExecutingMigrations"
                default_value = "false"
            }

            parameter "Flyway.Command.PlaceHolders" {
                display_settings = {
                    Octopus.ControlType = "MultiLineText"
                }
                help_text = <<-EOT
                        **Optional** for `migrate`, `info`, `validate`, `undo`, `check`, and `repair`.  **Ignored** for all other commands.
                        
                        [Placeholders](https://flywaydb.org/documentation/configuration/placeholder) to replace in SQL migrations.
                        
                        Each new line represents a new placeholder.  This will only work with string variable types, text and sensitive values.    
                        
                        Imagine this SQL Script
                        
                        ```
                        INSERT INTO ${Key1} (name) VALUES ('Mr. T')
                        GRANT SELECT ON SCHEMA ${flyway:defaultSchema} TO ${Key2}
                        ```
                        
                        Use the format **Name::Value**  for example:
                        
                        ```
                        Key1::My Super Awesome Value
                        
                        Key2::Other Super Awesome Value
                        ```
                        
                        This will replace `${Key1}` with `My Super Awesome Value` and `${Key2}` with `Other Super Awesome Value`.
                        
                        EOT
                label = "-PlaceHolders"
                default_value = ""
            }

            parameter "Flyway.Command.InfoSinceDate" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** with the `info` command and [Flyway Teams](https://flywaydb.org/documentation/usage/commandline/info#filtering-output) and Flyway Enterprise editions.  **Ignored** for all other commands.
                        
                        Limits info to show only migrations applied after this date, and any unapplied migrations. Must be in the format `dd/MM/yyyy HH:mm` (e.g. `01/12/2020 13:00`)
                        EOT
                label = "-InfoSinceDate"
                default_value = ""
            }

            parameter "Flyway.Command.InfoSinceVersion" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** with the `info` command and [Flyway Teams](https://flywaydb.org/documentation/usage/commandline/info#filtering-output) and Flyway Enterprise editions.  **Ignored** for all other commands.
                        
                        Limits info to show only migrations greater than or equal to this version, and any repeatable migrations. (e.g `1.1`)
                        EOT
                label = "-InfoSinceVersion"
                default_value = ""
            }

            parameter "Flyway.Command.BaseLineOnMigrate" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        true|True
                        false|False
                        EOT
                }
                help_text = <<-EOT
                        **Optional** when using `migrate`.  **Ignored** for all other commands.
                        
                        Whether to automatically call baseline when migrate is executed against a non-empty schema with no metadata table. This schema will then be baselined with the baselineVersion before executing the migrations. Only migrations above baselineVersion will then be applied.
                        
                        This is useful for initial Flyway production deployments on projects with an existing DB.
                        
                        Be careful when enabling this as it removes the safety net that ensures Flyway does not migrate the wrong database in case of a configuration mistake!
                        EOT
                label = "-baselineOnMigrate"
                default_value = "false"
            }

            parameter "Flyway.Command.BaselineVersion" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required** when using `Baseline` or when `BaselineOnMigrate` is set to `True`.  **Ignored** for all other commands.
                        
                        The version to tag an existing schema with when executing [baseline](https://flywaydb.org/documentation/command/baseline).
                        EOT
                label = "-baselineVersion"
                default_value = ""
            }

            parameter "Flyway.Command.BaselineDescription" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required** when using `Baseline`.  **Ignored** for all other commands.
                        
                        The Description to tag an existing schema with when executing [baseline](https://flywaydb.org/documentation/command/baseline).
                        EOT
                label = "-baseLineDescription"
                default_value = ""
            }

            parameter "Flyway.Command.Locations" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional** with the `info`,  `migrate`, `repair`, `undo`, `check`, and `validate` commands. 
                        
                        Specifies the location of the script files to execute.  If left blank, the `Extracted Path` of the package will be used.
                        
                        Example: filesystem:`#{Octopus.Action.Package[Flyway.Package.Value].ExtractedPath}/MySubFolder`
                        EOT
                label = "-Locations"
                default_value = ""
            }

            parameter "Flyway.Command.CheckBuildUrl" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required** when using `Check Changes` or `Check Drift` commands and `-snapshot.FileName` is empty.  
                        
                        **Please Note:** When `-snapshot.FileName` is not empty, this parameter is ignored.
                        
                        Flyway uses the URL to an existing database as a temporary database to perform the check logic against.  Flyway will clean this database, so if you specify a full database, you must ensure it is okay for Flyway to erase its schema.
                        
                        Examples:
                        - SQL Server: `jdbc:sqlserver://host:port;databaseName=database`
                        - Oracle: `jdbc:oracle:thin:@//host:port/service` or `jdbc:oracle:thin:@tns_entry`
                        - MySQL: `jdbc:mysql://host:port/database`
                        - PostgreSQL: `jdbc:postgresql://host:port/database`
                        - SQLite: `jdbc:sqlite:database`
                        
                        Please refer to [documentation](https://flywaydb.org/documentation/database/sqlserver) for further examples.
                        EOT
                label = "-check.BuildUrl"
                default_value = ""
            }

            parameter "Flyway.Database.Check.User" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The username of the user for the build database.  Use this if the build database needs a separate username and password from the authentication information supplied above.
                        
                        **Please Note:** When `-snapshot.FileName` is not empty, this parameter is ignored.
                        EOT
                label = "-check.BuildUser"
                default_value = ""
            }

            parameter "Flyway.Database.Check.User.Password" {
                display_settings = {
                    Octopus.ControlType = "Sensitive"
                }
                help_text = <<-EOT
                        **Optional**
                        
                        The password of the user for the build database.  Use this if the build database needs a separate username and password from the authentication information supplied above.
                        
                        **Please Note:** When `-snapshot.FileName` is not empty, this parameter is ignored.
                        EOT
                label = "-check.BuildPassword"
                default_value = ""
            }

            parameter "Flyway.Command.FailOnDrift" {
                display_settings = {
                    Octopus.ControlType = "Select"
                    Octopus.SelectOptions = <<-EOT
                        true|True
                        false|False
                        EOT
                }
                help_text = <<-EOT
                        **Required** when using `Check Drift`.  Ignored for all other commands.
                        
                        Indicates if Flyway will terminate with a non-zero return code if drift is detected.  When using `Check Drift` with a snapshot and you want to see the changes, set this to `false`
                        EOT
                label = "-check.failOnDrift"
                default_value = "true"
            }

            parameter "Flyway.Command.Snapshot.FileName" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = <<-EOT
                        **Required** when using `Snapshot`.  **Optional** when using the `Check Drift` command.  **Ignored** for all other commands.
                        
                        The name, including the path, of the snapshot file to create or use.  
                        
                        If this parameter is populated the `-check.BuildUser`, `check.BuildPassword`, and `-check.BuildUrl` parameters are all ignored.
                        
                        **Hint:** If executing this step in an execution container, consider `../../../` as the path prefix as the script will execute in `/etc/octopus/default/Work/[Random Folder Name]/Flyway.Package.Value`.  `/etc/octopus/default` is mounted as a volume.  Or leverage a NAS or other file share.
                        
                        **Important:** You will need this file for future steps. It must be stored in a non-temporary location.  By default, Octopus runs this script in a temporary location on a worker.  That location is deleted automatically once this step is complete.  If you do not supply a path, the file will be deleted.
                        EOT
                label = "-snapshot.FileName"
                default_value = ""
            }

            parameter "Flyway.Additional.Arguments" {
                display_settings = {
                    Octopus.ControlType = "SingleLineText"
                }
                help_text = "Any additional arguments that need to be passed (ie `-table=\"MyTable\")"
                label = "Additional arguments"
                default_value = ""
            }
        }

        packages "Flyway.Package.Value" {
            acquisition_location = "Server"
            feed = "octopus-server-built-in"
            package_id = ""
            properties = {
                Extract = "True"
                PackageParameterName = "Flyway.Package.Value"
                SelectionMode = "deferred"
            }
        }
    }
}